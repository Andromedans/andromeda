\documentclass{article}

\usepackage{times}
\usepackage{mathpartir}
\usepackage{amsmath,amsfonts,amssymb}

%% Macros here

% Universe indices

\newcommand{\NN}{\mathbb{N}} % God-given numbers

\newcommand{\PP}{\mathbb{P}} % the poset of universe indices
\newcommand{\FF}{\mathbb{F}} % the subposet of fibered universe indices
\newcommand{\zero}{o} % this is not o, it is omicron

\newcommand{\piClose}[2]{\mathsf{max}(#1,#2)}   % the universe containing a pi with given domain and codomain
\newcommand{\uClose}[1]{\mathsf{succ}(#1)}  % the universe containing the given universe's name.

% Generic entities
\newcommand{\G}{\Gamma} % a context
\newcommand{\T}{T} % a type
\newcommand{\U}{U} % another type
\newcommand{\x}{x} % a term variable
\newcommand{\y}{y} % another term variable
\newcommand{\e}{e} % a term

\newcommand{\rulename}[1]{\text{\textsc{#1}}}

%% Syntax
\newcommand{\bnf}{\ \mathrel{{:}{:}{=}}\ }
\newcommand{\bnfor}{\ \mid\ \ }

%% Syntactic constructs
\newcommand{\ctxempty}{\bullet} % empty context
\newcommand{\ctxextend}[3]{#1,\, #2\, {:}\, #3} % extended context

\newcommand{\subst}[3]{#1[#3/#2]} % substitution
\newcommand{\substs}[2]{#1[#2]} % substitution of many variables

\newcommand{\Universe}[1]{\mathbb{U}^{#1}} % non-fibered universe
\newcommand{\El}[2]{\mathsf{El}^{#1} #2} % the type named by #2

\newcommand{\Unit}{\mathsf{Unit}} % The unit type
\newcommand{\Prod}[2]{\mathop{\textstyle\prod_{(#1 {:} #2)}}} % dependent product

\newcommand{\lam}[2]{\lambda #1 {:} #2 .\,} % $\lambda$-abstraction
\newcommand{\app}[2]{#1\,#2} % application

\newcommand{\abst}[2]{[#1 \,.\, #2]} % abstraction
\newcommand{\ascribe}[2]{#1 \,{:}{:}\, #2} % type ascription

\newcommand{\unitTerm}{\star} % the element of the unit type

\newcommand{\coerce}[3]{\mathsf{coerce}^{#2{\mapsto}#3}\ #1}

\newcommand{\PrEqual}[3]{\mathsf{Paths}_{#1}(#2,#3)} % Propositional Equality type
\newcommand{\JuEqual}[3]{\mathsf{Id}_{#1}(#2,#3)} % Judgmental Equality type

\newcommand{\PrElim}[6]{\mathsf{J}_{#1}(#2, #3, #4, #5, #6)} % Propositional equality eliminator
\newcommand{\JuElim}[6]{\mathsf{G}_{#1}(#2, #3, #4, #5, #6)} % Judgmental equality eliminator

\newcommand{\prRefl}[1]{\mathop{\mathsf{idpath}_{#1}}}  % Propositional refl
\newcommand{\juRefl}[1]{\mathop{\mathsf{refl}_{#1}}}    % Judgmental refl

% names
\newcommand{\nUnit}{\mathsf{unit}} % name of unit type
\newcommand{\nProd}[3]{\pi^{#1} \,#2\,{:}\,#3 \,.\ } % name of a dependent product
\newcommand{\nUniverse}[1]{u^{#1}}  % name of a universe
\newcommand{\nPrEqual}[4]{\mathsf{paths}^{#1}_{#2}(#3,#4)} % Propositional Equality type
\newcommand{\nJuEqual}[4]{\mathsf{id}^{#1}_{#2}(#3,#4)} % Judgmental Equality type


% judgments
\newcommand{\isctx}[1]{#1\;\mathsf{ctx}} % well formed context
\newcommand{\istype}[2]{#1 \vdash #2\;\mathsf{type}} % well formed type
\newcommand{\isfib}[2]{#1 \vdash #2\;\mathsf{fibered}} % is a fibered type
\newcommand{\isterm}[3]{#1 \vdash\,#2\,:\,#3} % well formed term

\newcommand{\eqtype}[3]{#1 \vdash #2 \equiv #3} % equal types
\newcommand{\eqterm}[4]{#1 \vdash #2 \equiv #3 : #4} % equal terms

\newcommand{\chkterm}[3]{#1 \vdash #2 \Leftarrow #3} % checking
\newcommand{\synterm}[3]{#1 \vdash #2 \Rightarrow #3} % synthesis

% hints

\newcommand{\hintin}[1]{\mathsf{hint}\;#1\;\mathsf{in}\;} % term equality hint

\newcommand{\isctxalg}[2]{\ctxs{#1}{#2} \Leftarrow \mathsf{ctx}}
\newcommand{\istypealg}[2]{#1 \vdash #2 \Leftarrow \mathsf{type}} % well formed type
\newcommand{\isfibalg}[2]{#1 \vdash #2 \Leftarrow \mathsf{fibered}} % is a fibered type
\newcommand{\eqtypealg}[3]{#1 \vdash #2 \thickapprox #3} % equal types
\newcommand{\eqtermalg}[4]{#1 \vdash #2 \thickapprox #3 : #4} % equal terms

\newcommand{\eqtermhint}[2]{#1 \,{\equiv}\, #2 } %\,{:}\, #3)}
\newcommand{\redtermhint}[2]{#1 \,{\leadsto}\, #2 } %\,{:}\, #3)}

\renewcommand{\H}{\mathcal{H}}      % term hint list
\newcommand{\hintempty}{\circ}      % empty hint list
\newcommand{\addhinteq}[3]{#1, \eqtermhint{#2}{#3}} % extended hint list
\newcommand{\addhintred}[3]{#1, \redtermhint{#2}{#3}} % extended hint list
\newcommand{\ctxs}[2]{#1\,;\,#2}
\newcommand{\GH}{\ctxs{\G}{\H}}           % combined context and hints


% normalization

\newcommand{\whnf}[3]{#1 \vdash #2 \leadsto #3 } % "normalization"

\begin{document}

\title{Brazilian type theory}
\author{Andrej Bauer \and Christopher A. Stone}
\maketitle

\section{Universe indices}
\label{sec:universe-indices}

There is a pointed poset $(\PP, {\leq}, \zero)$ of \emph{universe
  indices} and a subset $\FF \subseteq \PP$ of \emph{fibered indices}.
For example, we may take
%
\begin{equation*}
  \PP = \{0,1\} \times \NN
\end{equation*}
%
with the lexicographic order, $\zero = (0,0)$ and $\FF = \{0\} \times
\NN$. We use lowercase Greek letters for universe indices.

We assume the following partial functions are given:
\begin{itemize}
  \item $\piClose{\cdot}{\cdot} : \PP \times \PP \rightharpoonup \PP$
  \item $\uClose{\cdot}  : \PP \rightharpoonup \PP$
\end{itemize}
%
These are \emph{not} required to compute maximum or successor, but we use the suggestive
notation because in the standard case they do compute maxima and succesors.

\section{The orthodox formulation}
\label{sec:orthodox-formulation}

In this section we give the formulation of Brazilian type theory in the orthodox way, with
typing and equality judgments.

\subsection{Syntax}
\label{sec:syntax}

Contexts:
%
\begin{equation*}
  \G
  \begin{aligned}[t]
    \bnf   {}& \ctxempty & & \text{empty context}\\
    \bnfor {}& \ctxextend{\G}{\x}{\T} & & \text{context extended with $x : T$}
  \end{aligned}
\end{equation*}
%
Types:
%
\begin{equation*}
  \T, \U
  \begin{aligned}[t]
    \bnf   {}& \Universe{\alpha} & & \text{universe}\\
    \bnfor {}& \El{\alpha}{\e} & & \text{type named by $e$}\\
    \bnfor {}& \Unit & & \text{the unit type}\\
    \bnfor {}& \Prod{x}{\T} \U & & \text{product}\\
    \bnfor {}& \PrEqual{T}{\e_1}{\e_2} & & \text{path type}\\
    \bnfor {}& \JuEqual{T}{\e_1}{\e_2} & & \text{equality type}
  \end{aligned}
\end{equation*}
%
Terms:
%
\begin{equation*}
  \e
  \begin{aligned}[t]
    \bnf   {}&  \x   &&\text{variable} \\
    \bnfor {}&  \lam{\x}{\T} \e  &&\text{$\lambda$-abstraction} \\
    \bnfor {}&   \app{\e_1}{\e_2}  &&\text{application} \\
    \bnfor {}&  \unitTerm  &&\text{the element of unit type} \\
    \bnfor {}&  \prRefl{\T}{\e}  &&\text{identity path} \\
    \bnfor {}&  \PrElim{\T}{\abst{x\,y\,p}{\U}}{\abst{z}{\e_1}}{\e_2}{\e_3}{\e_4}  &&\text{path eliminator} \\
    \bnfor {}&  \juRefl{\T}{\e}  &&\text{reflexivity} \\
    \bnfor {}&  \JuElim{\T}{\abst{x\,y\,p}{\U}}{\abst{z}{\e_1}}{\e_2}{\e_3}{\e_4}  &&\text{equality eliminator} \\
    \bnfor {}&  \nUnit  &&\text{the name of unit type} \\
    \bnfor {}&  \nProd{\alpha,\beta}{\x}{\e_1} \e_2  &&\text{the name of product type} \\
    \bnfor {}&  \nUniverse{\alpha} &&\text{the name of a universe} \\
    \bnfor {}&  \coerce{\e}{\alpha}{\beta}  &&\text{universe coercion} \\
    \bnfor {}&  \nPrEqual{\alpha}{\e_1}{\e_2}{\e_3}  &&\text{the name of a path type} \\
    \bnfor {}&  \nJuEqual{\alpha}{\e_1}{\e_2}{\e_3}  &&\text{the name of an equality type}
  \end{aligned}
\end{equation*}

\subsection{Judgments}
\label{sec:judgments}

\begin{align*}
& \isctx{\G} & & \text{$\G$ is a well formed context} \\
& \istype{\G}{\T} & & \text{$\T$ is a type in context $\G$} \\
& \isfib{\G}{\T} & & \text{$\T$ is a fibered type in context $\G$} \\
& \isterm{\G}{\e}{\T} & & \text{$\e$ is a well formed term of type $\T$ in context $\G$} \\
& \eqtype{\G}{\T}{\U} & & \text{$\T$ and $\U$ are equal types in context $\G$} \\
& \eqterm{\G}{\e_1}{\e_2}{\T} & & \text{$e_1$ and $e_2$ are equal terms of type $\T$ in context $\G$}
\end{align*}

\subsection{Contexts}
\label{sec:contexts}

\begin{mathpar}
  \infer[\rulename{ctx-empty}]
  { }
  {\isctx{\ctxempty}}

  \infer[\rulename{ctx-extend}]
  {\isctx{\G} \\
   \istype{\G}{\T}
  }
  {\isctx{\ctxextend{\G}{\x}{\T}}}
\end{mathpar}

\subsection{Types}
\label{sec:types}

\begin{mathpar}
  \infer[\rulename{ty-universe}]
  {\isctx{\G} \\
   \alpha \in \PP
  }
  {\istype{\G}{\Universe{\alpha}}}

  \infer[\rulename{ty-prod}]
  {\istype{\G}{\T} \\
   \istype{\ctxextend{\G}{\x}{\T}}{\U}
  }
  {\istype{\G}{\Prod{\x}{\T}{\U}}}

  \infer[\rulename{ty-el}]
  {\isterm{\G}{\e}{\Universe{\alpha}}}
  {\istype{\G}{\El{\alpha}{\e}}}

  \infer[\rulename{ty-unit}]
  {\isctx{\G}}
  {\istype{\G}{\Unit}}

  \infer[\rulename{ty-paths}]
  {\isfib{\G}{\T}\\
   \isterm{\G}{\e_1}{\T}\\
   \isterm{\G}{\e_2}{\T}
  }
  {\istype{\G}{\PrEqual{\T}{\e_1}{\e_2}}}

  \infer[\rulename{ty-id}]
  {\istype{\G}{\T}\\
   \isterm{\G}{\e_1}{\T}\\
   \isterm{\G}{\e_2}{\T}
  }
  {\istype{\G}{\JuEqual{\T}{\e_1}{\e_2}}}
\end{mathpar}

\subsection{Fibered types}
\label{sec:fibered-types}

\begin{mathpar}
  \infer[\rulename{fib-universe}]
  {\isctx{\G} \\
   \alpha \in \PP
  }
  {\isfib{\G}{\Universe{\alpha}}}

  \infer[\rulename{fib-prod}]
  {\isfib{\G}{\T} \\
   \isfib{\ctxextend{\G}{\x}{\T}}{\U}
  }
  {\isfib{\G}{\Prod{\x}{\T}{\U}}}

  \infer[\rulename{fib-el}]
  {\isterm{\G}{\e}{\Universe{\alpha}} \\
   \alpha \in \FF
  }
  {\isfib{\G}{\El{\alpha}{\e}}}

  \infer[\rulename{fib-unit}]
  {\isctx{\G} \\
   \zero\in\FF }
  {\istype{\G}{\Unit}}

  \infer[\rulename{fib-paths}]
  {\isfib{\G}{\T}\\
   \isterm{\G}{\e_1}{\T}\\
   \isterm{\G}{\e_2}{\T}
  }
  {\isfib{\G}{\PrEqual{\T}{\e_1}{\e_2}}}



\end{mathpar}

\subsection{Terms}
\label{sec:terms}

General terms:
\begin{mathpar}
  \infer[\rulename{term-eq}]
  {\isterm{\G}{\e}{\T} \\
   \eqtype{\G}{\T}{\U}
  }
  {\isterm{\G}{\e}{\U}}

  \infer[\rulename{term-var}]
  {\isctx{\G} \\
   (\x{:}\T) \in \G
  }
  {\isterm{\G}{\x}{\T}}
\end{mathpar}

\noindent
Products:
\begin{mathpar}
  \infer[\rulename{term-abs}]
  {\isterm{\ctxextend{\G}{\x}{\T}}{\e}{\U}}
  {\isterm{\G}{(\lam{\x}{\T}{\e})}{\Prod{\x}{\T}{\U}}}

  \infer[\rulename{term-app}]
  {\isterm{\G}{\e_1}{\Prod{x}{\T} \U} \\
   \isterm{\G}{\e_2}{\T}
  }
  {\isterm{\G}{\app{\e_1}{\e_2}}{\subst{\U}{\x}{\e_2}}}
\end{mathpar}

\noindent
Paths:
\begin{mathpar}
  \infer[\rulename{term-idpath}]
  {\isterm{\G}{\e}{\T}\\
   \isfib{\G}{\T}}
  {\isterm{\G}{\prRefl{\T}{\e}}{\PrEqual{\T}{\e}{\e}}}

  \infer[\rulename{term-j}]
  {\isfib{\G}{\T}
   \\\\
   \isfib{
     \ctxextend{\ctxextend{\ctxextend{\G}{x}{\T}}{y}{\T}}{p}{\PrEqual{\T}{x}{y}}
   }{\U}
   \\
   \isterm
     {\ctxextend{\G}{z}{\T}}
     {\e_1}
     {\substs{\U}{z/x, z/y, (\prRefl{\T}{z})/p}}
   \\
   \isterm{\G}{\e_2}{\T} \\
   \isterm{\G}{\e_3}{\T} \\
   \isterm{\G}{\e_4}{\PrEqual{\T}{\e_2}{\e_3}}
  }
  {\isterm
     {\G}
     {\PrElim{\T}
        {\abst{x\,y\,p}{\U}}
        {\abst{z}{\e_1}}
        {\e_2}
        {\e_3}
        {\e_4}
     }
     {\substs{\U}{\e_2/x, \e_3/y, \e_4/p}}
  }
\end{mathpar}

\noindent
Equality types:
\begin{mathpar}
  \infer[\rulename{term-refl}]
  {\isterm{\G}{\e}{\T}}
  {\isterm{\G}{\juRefl{\T}{\e}}{\JuEqual{\T}{\e}{\e}}}

  \infer[\rulename{term-g}]
  {\istype{\G}{\T}
   \\\\
   \istype{
     \ctxextend{\ctxextend{\ctxextend{\G}{x}{\T}}{y}{\T}}{p}{\JuEqual{\T}{x}{y}}
   }{P}
   \\\\
   \isterm
     {\ctxextend{\G}{z}{\T}}
     {\e_1}
     {\substs{P}{z/x, z/y, (\juRefl{\T}{z})/p}}
   \\
   \isterm{\G}{\e_2}{\T} \\
   \isterm{\G}{\e_3}{\T} \\
   \isterm{\G}{\e_4}{\JuEqual{\T}{\e_2}{\e_3}}
  }
  {\isterm
     {\G}
     {\JuElim{\T}
        {\abst{x\,y\,p}{P}}
        {\abst{z}{\e_1}}
        {\e_2}
        {\e_3}
        {\e_4}
     }
     {\substs{P}{\e_2/x, \e_3/y, \e_4/p}}
  }

\end{mathpar}


\noindent
Unit:
\begin{mathpar}
\infer[\rulename{term-star}]
  {\isctx{\G}}
  {\isterm{\G}{\unitTerm}{\Unit}}
\end{mathpar}

\noindent
Names:
\begin{mathpar}
  \infer[\rulename{term-coerce}]
  {\isterm{\G}{\e}{\Universe{\alpha}}\\
   \alpha \leq \beta}
  {\isterm{\G}{\coerce{\e}{\alpha}{\beta}}{\Universe{\beta}}}

  \infer[\rulename{name-unit}]
  {\isctx{\G}}
  {\isterm{\G}{\nUnit}{\Universe{\zero}}}

  \infer[\rulename{name-universe}]
  {\isctx{\G} \\ \uClose{\alpha} = \beta }
  {\isterm{\G}{\nUniverse{\alpha}}{\Universe{\beta}}}

  \infer[\rulename{name-prod}]
  {\isterm{\G}{\e_1}{\Universe{\alpha}} \\
   \isterm{\ctxextend{\G}{\x}{\El{\alpha}{\e_1}}}{\e_2}{\Universe{\beta}} \\
   \piClose{\alpha}{\beta} = \gamma
  }
  {\isterm{\G}{(\nProd{\alpha,\beta}{\x}{\e_1} \e_2)}{\Universe{\gamma}}}

  \infer[\rulename{name-paths}]
  {\isterm{\G}{\e_\T}{\Universe{\alpha}}\\
   \alpha\in\FF\\
   \isterm{\G}{\e_1}{\El{\alpha}{\e_\T}}\\
   \isterm{\G}{\e_2}{\El{\alpha}{\e_\T}}
  }
  {\isterm{\G}{\nPrEqual{\alpha}{\e_T}{\e_1}{\e_2}}{\Universe{\alpha}}}

  \infer[\rulename{name-id}]
  {\isterm{\G}{\e_\T}{\Universe{\alpha}}\\
   \isterm{\G}{\e_1}{\El{\alpha}{\e_\T}}\\
   \isterm{\G}{\e_2}{\El{\alpha}{\e_\T}}
  }
  {\isterm{\G}{\nJuEqual{\alpha}{\e_\T}{\e_1}{\e_2}}{\Universe{\alpha}}}

\end{mathpar}

\subsection{Type Equality}

\noindent
General rules:
\begin{mathpar}
  \infer[\rulename{tyeq-refl}]
  {\istype{\G}{\T}}
  {\eqtype{\G}{\T}{\T}}

  \infer[\rulename{tyeq-sym}]
  {\eqtype{\G}{\U}{\T}}
  {\eqtype{\G}{\T}{\U}}

  \infer[\rulename{tyeq-trans}]
  {\eqtype{\G}{\T}{\T'}\\
   \eqtype{\G}{\T'}{\U}}
  {\eqtype{\G}{\T}{\U}}
\end{mathpar}

\noindent
Type formers are congruences:
\begin{mathpar}
  \infer[\rulename{tycong-el}]
  {\eqterm{\G}{\e_1}{\e_2}{\Universe{\alpha}}}
  {\eqtype{\G}{\El{\alpha}{\e_1}}{\El{\alpha}{\e_2}}}

  \infer[\rulename{tycong-prod}]
  {\eqtype{\G}{\T_1}{\U_1}\\
   \eqtype{\ctxextend{\G}{\x}{\T_1}}{\T_2}{\U_2}}
  {\eqtype{\G}{\Prod{\x}{\T_1}{\T_2}}{\Prod{\x}{\U_1}{\U_2}}}

  \infer[\rulename{tycong-paths}]
  {\isfib{\G}{\T}\\
   \isfib{\G}{\U}\\\\
   \eqtype{\G}{\T}{\U}\\
   \eqterm{\G}{\e_1}{\e'_1}{\T}\\
   \eqterm{\G}{\e_2}{\e'_2}{\T}
  }
  {\eqtype{\G}{\PrEqual{\T}{\e_1}{\e_2}}
              {\PrEqual{\U}{\e'_1}{\e'_2}}}

  \infer[\rulename{tycong-id}]
  {\eqtype{\G}{\T}{\U}\\
   \eqterm{\G}{\e_1}{\e'_1}{\T}\\
   \eqterm{\G}{\e_2}{\e'_2}{\T}
  }
  {\eqtype{\G}{\JuEqual{\T}{\e_1}{\e_2}}
              {\JuEqual{\U}{\e'_1}{\e'_2}}}
\end{mathpar}

\noindent
Computation of types from names:
\begin{mathpar}
  \infer[\rulename{tyeq-el-pi}]
  {\isterm{\G}{\e_1}{\Universe{\alpha}} \\
   \isterm{\ctxextend{\G}{x}{\El{\alpha}{\e_1}}}{\e_2}{\Universe{\beta}} \\
   \piClose{\alpha}{\beta} = \gamma}
  {\eqtype{\G}{\El{\gamma}{(\nProd{\alpha,\beta}{\x}{\e_1}{\e_2})}}
              {\Prod{\x}{\El{\alpha}{\e_1}}{\El{\beta}{\e_2}}}}

  \infer[\rulename{tyeq-el-unit}]
  { }
  {\eqtype{\G}{\El{\zero}{\nUnit}}{\Unit}}

  \infer[\rulename{tyeq-el-coerce}]
  {\isterm{\G}{\e}{\Universe{\alpha}} \\
    \alpha \leq \beta
  }
  {\eqtype{\G}{\El{\beta}(\coerce{\e}{\alpha}{\beta})}
              {\El{\alpha}{e}}}

  \infer[\rulename{tyeq-el-paths}]
  {\isterm{\G}{\e_\T}{\Universe{\alpha}}\\
   \alpha\in\FF\\
   \isterm{\G}{\e_1}{\El{\alpha}{\e_\T}}\\
   \isterm{\G}{\e_2}{\El{\alpha}{\e_\T}}
  }
  {\eqtype{\G}{\El{\alpha}{(\nPrEqual{\alpha}{\e_T}{\e_1}{\e_2})}}
          {\PrEqual{\El{\alpha}{\e_\T}}{\e_1}{\e_2}}}

  \infer[\rulename{tyeq-el-id}]
  {\isterm{\G}{\e_\T}{\Universe{\alpha}}\\
   \isterm{\G}{\e_1}{\El{\alpha}{\e_\T}}\\
   \isterm{\G}{\e_2}{\El{\alpha}{\e_\T}}
  }
  {\eqtype{\G}{\El{\alpha}{(\nJuEqual{\alpha}{\e_\T}{\e_1}{\e_2})}}
          {\JuEqual{\El{\alpha}{\e_\T}}{\e_1}{\e_2}}}

\end{mathpar}

\subsection{Term Equality}

General rules:
\begin{mathpar}
  \infer[\rulename{eq-refl}]
  {\isterm{\G}{\e}{\T}}
  {\eqterm{\G}{\e}{\e}{\T}}

  \infer[\rulename{eq-sym}]
  {\eqterm{\G}{\e_2}{\e_1}{\T}}
  {\eqterm{\G}{\e_1}{\e_2}{\T}}

  \infer[\rulename{eq-trans}]
  {\eqterm{\G}{\e_1}{\e_2}{\T}\\
   \eqterm{\G}{\e_2}{\e_3}{\T}}
  {\eqterm{\G}{\e_1}{\e_3}{\T}}

  \infer[\rulename{eq-eq}]
  {\eqterm{\G}{\e_1}{\e_2}{\T}\\
    \eqtype{\G}{\T}{\U}}
  {\eqterm{\G}{\e_1}{\e_2}{\U}}
\end{mathpar}

\noindent
Congruence rules for products:
%
\begin{mathpar}
  \infer[\rulename{cong-abs}]
  {\eqtype{\G}{\T_1}{\U_1}\\
    \eqterm{\ctxextend{\G}{\x}{\T_1}}{\e_1}{\e_2}{\T_2}}
  {\eqterm{\G}{(\lam{\x}{\T_1}{\e_1})}
              {(\lam{\x}{\U_1}{\e_2})}
              {\Prod{\x}{\T_1}{\T_2}}}

  \infer[\rulename{cong-app}]
  {\eqterm{\G}{\e_1}{\e'_1}{\Prod{\x}{\T}{\U}}\\
   \eqterm{\G}{\e_2}{\e'_2}{\T}}
  {\eqterm{\G}{\app{\e_1}{\e_2}}{\app{\e'_1}{\e'_2}}{\subst{\U}{\x}{\e_2}}}
\end{mathpar}

\noindent
Other rules for products:
%
\begin{mathpar}
\infer[\rulename{eq-beta}]
  {\isterm{\ctxextend{\G}{\x}{\T}}{\e_1}{\U}\\
    \isterm{\G}{\e_2}{\T}}
  {\eqterm{\G}{\app{(\lam{\x}{\T}{\e_1})}{\e_2}}
              {\subst{\e_1}{\x}{\e_2}}
              {\subst{\U}{\x}{\e_2}}}

  \infer[\rulename{eq-ext}]
  {\isterm{\G}{\e_1}{\Prod{\x}{\T}{\U}}\\
   \isterm{\G}{\e_2}{\Prod{\x}{\T}{\U}}\\
   \eqterm{\ctxextend{\G}{\x}{\T}}{\app{\e_1}{\x}}
          {\app{\e_2}{\x}}{\U}
  }
  {\eqterm{\G}{\e_1}{\e_2}{\Prod{\x}{\T}{\U}}}
\end{mathpar}

\noindent
Congruence rules for paths:
%
\begin{mathpar}
\infer[\rulename{cong-idpath}]
  {\eqterm{\G}{\e_1}{\e_2}{\T}\\
   \eqtype{\G}{\T}{\U}\\
   \isfib{\G}{\T}\\
   \isfib{\G}{\U}}
  {\eqterm{\G}{\prRefl{\T}{\e_1}}{\prRefl{\U}{\e_2}}{\PrEqual{\T}{\e_1}{\e_1}}}

  \infer[\rulename{cong-j}]
  {\isfib{\G}{\T} \\
   \isfib{\G}{\U}
   \\\\
   \isfib{
     \ctxextend{\ctxextend{\ctxextend{\G}{x}{\T}}{y}{\T}}{p}{\PrEqual{\T}{x}{y}}
   }{P}
   \\
   \isfib{
     \ctxextend{\ctxextend{\ctxextend{\G}{x}{\U}}{y}{\U}}{p}{\PrEqual{\U}{x}{y}}
   }{Q}
   \\\\
   \isterm
     {\ctxextend{\G}{z}{\T}}
     {\e_1}
     {\substs{P}{z/x, z/y, (\prRefl{\T}{z})/p}}
   \\
   \isterm
     {\ctxextend{\G}{z}{\U}}
     {\e'_1}
     {\substs{Q}{z/x, z/y, (\prRefl{\U}{z})/p}}
   \\\\
   \isterm{\G}{\e_2}{\T} \\
   \isterm{\G}{\e_3}{\T} \\
   \isterm{\G}{\e_4}{\PrEqual{\T}{\e_2}{\e_3}}
   \\\\
   \isterm{\G}{\e'_2}{\U} \\
   \isterm{\G}{\e'_3}{\U} \\
   \isterm{\G}{\e'_4}{\PrEqual{\U}{\e'_2}{\e'_3}}
   \\\\
   \eqtype{\G}{\T}{\U} \\
   \eqtype{
     \ctxextend{\ctxextend{\ctxextend{\G}{x}{\T}}{y}{\T}}{p}{\PrEqual{\T}{x}{y}}
   }{P}{Q} \\\\
   \eqterm{\ctxextend{\G}{z}{\T}}{\e_1}{\e'_1}{\substs{P}{z/x, z/y, (\prRefl{\T}{z})/p}}
   \\\\
   \eqterm{\G}{\e_2}{\e'_2}{T} \\
   \eqterm{\G}{\e_3}{\e'_3}{T} \\
   \eqterm{\G}{\e_4}{\e'_4}{\PrEqual{\T}{\e_2}{\e_3}}
  }
  {\eqterm
     {\G}
     {\PrElim{\T}
        {\abst{x\,y\,p}{P}}
        {\abst{z}{\e_1}}
        {\e_2}
        {\e_3}
        {\e_4}
     }
     {\PrElim{\U}
        {\abst{x\,y\,p}{Q}}
        {\abst{z}{\e'_1}}
        {\e'_2}
        {\e'_3}
        {\e'_4}
     }
     {\substs{P}{\e_2/x, \e_3/y, \e_4/p}}
  }

\end{mathpar}

\noindent
Computation rule for paths:
%
\begin{mathpar}
  \infer[\rulename{eq-J}]
  {\isfib{\G}{\T}
   \\
   \isfib{
     \ctxextend{\ctxextend{\ctxextend{\G}{x}{\T}}{y}{\T}}{p}{\PrEqual{\T}{x}{y}}
   }{P}
   \\\\
   \isterm
     {\ctxextend{\G}{z}{\T}}
     {\e_1}
     {\substs{P}{z/x, z/y, (\prRefl{\T}{z})/p}}
   \\
   \isterm{\G}{\e_2}{\T}
  }
  {\eqterm{\G}
   {\PrElim{\T}
        {\abst{x\,y\,p}{P}}
        {\abst{z}{\e_1}}
        {\e_2}
        {\e_2}
        {\prRefl{\T}{\e_2}}
   }
   {\subst{\e_1}{z}{\e_2}}
   {\substs{P}{\e_2/x, \e_2/x, (\prRefl{T}{\e_2})/p}}
  }
\end{mathpar}

\noindent
Congruence rules for equalities:
%
\begin{mathpar}
\infer[\rulename{cong-refl}]
{\eqterm{\G}{\e_1}{\e_2}{\T}\\
 \eqtype{\G}{\T}{\U}}
{\eqterm{\G}{\juRefl{\T}{\e_1}}{\juRefl{\U}{\e_2}}{\JuEqual{\T}{\e_1}{\e_1}}}

\infer[\rulename{cong-g}]
  {\istype{\G}{\T} \\
   \istype{\G}{\U}
   \\\\
   \istype{
     \ctxextend{\ctxextend{\ctxextend{\G}{x}{\T}}{y}{\T}}{p}{\JuEqual{\T}{x}{y}}
   }{P}
   \\
   \istype{
     \ctxextend{\ctxextend{\ctxextend{\G}{x}{\U}}{y}{\U}}{z}{\JuEqual{\U}{x}{y}}
   }{Q}
   \\\\
   \isterm
     {\ctxextend{\G}{z}{\T}}
     {\e_1}
     {\substs{P}{z/x, z/y, (\juRefl{\T}{z})/p}}
   \\
   \isterm
     {\ctxextend{\G}{z}{\U}}
     {\e'_1}
     {\substs{Q}{z/x, z/y, (\juRefl{\U}{z})/p}}
   \\\\
   \isterm{\G}{\e_2}{\T} \\
   \isterm{\G}{\e_3}{\T} \\
   \isterm{\G}{\e_4}{\JuEqual{\T}{\e_2}{\e_3}} \\\\
   \isterm{\G}{\e'_2}{\U} \\
   \isterm{\G}{\e'_3}{\U} \\
   \isterm{\G}{\e'_4}{\JuEqual{\U}{\e'_2}{\e'_3}}
   \\\\
   \eqtype{\G}{\T}{\U} \\
   \eqtype{
     \ctxextend{\ctxextend{\ctxextend{\G}{x}{\T}}{y}{\T}}{p}{\JuEqual{\T}{x}{y}}
   }{P}{Q} \\\\
   \eqterm{\ctxextend{\G}{z}{\T}}{\e_1}{\e'_1}{\substs{P}{z/x, z/y, (\juRefl{\T}{z})/p}}
   \\\\
   \eqterm{\G}{\e_2}{\e'_2}{T} \\
   \eqterm{\G}{\e_3}{\e'_3}{T} \\
   \eqterm{\G}{\e_4}{\e'_4}{\JuEqual{\T}{\e_2}{\e_3}}
  }
  {\eqterm
     {\G}
     {\JuElim{\T}
        {\abst{x\,y\,p}{P}}
        {\abst{z}{\e_1}}
        {\e_2}
        {\e_3}
        {\e_4}
     }
     {\JuElim{\U}
        {\abst{x\,y\,p}{Q}}
        {\abst{z}{\e'_1}}
        {\e'_2}
        {\e'_3}
        {\e'_4}
     }
     {\substs{P}{\e_2/x, \e_3/y, \e_4/p}}
  }
\end{mathpar}

\noindent
Equality reflection
%
\begin{mathpar}
  \infer[\rulename{eq-reflection}]
  {\isterm{\G}{\e}{\JuEqual{\T}{\e_1}{\e_2}}}
  {\eqterm{\G}{\e_1}{\e_2}{\T}}
\end{mathpar}

\noindent
Computation rule for equality:
%
\begin{mathpar}
  \infer[\rulename{eq-G}]
  {\istype{\G}{\T}
   \\
   \istype{
     \ctxextend{\ctxextend{\ctxextend{\G}{x}{\T}}{y}{\T}}{p}{\JuEqual{\T}{x}{y}}
   }{P}
   \\\\
   \isterm
     {\ctxextend{\G}{z}{\T}}
     {\e_1}
     {\substs{P}{z/x, z/y, (\juRefl{\T}{z})/p}}
   \\
   \isterm{\G}{\e_2}{\T}
  }
  {\eqterm{\G}
   {\JuElim{\T}
        {\abst{x\,y\,p}{P}}
        {\abst{z}{\e_1}}
        {\e_2}
        {\e_2}
        {\juRefl{\T}{\e_2}}
   }
   {\subst{\e_1}{z}{\e_2}}
   {\substs{P}{\e_2/x, \e_2/x, (\juRefl{T}{\e_2})/p}}
  }
\end{mathpar}

\noindent
Congruence rules for names:
%
\begin{mathpar}
\infer[\rulename{cong-name-prod}]
  {\eqterm{\G}{\e_1}{\e'_1}{\Universe{\alpha}}\\
   \eqterm{\ctxextend{\G}{\x}{\El{\alpha}{\e_1}}}{\e_2}{\e'_2}{\Universe{\beta}} \\
   \piClose{\alpha}{\beta} = \gamma}
  {\eqterm{\G}{\nProd{\alpha,\beta}{\x}{\e_1}{\e_2}}{\nProd{\alpha,\beta}{\x}{\e'_1}{\e'_2}}{\Universe{\gamma}}}

\infer[\rulename{cong-name-universe}]
{\isctx{\G} \\
  \uClose{\alpha} = \gamma
}
{\eqterm{\G}{\nUniverse{\alpha}}{\nUniverse{\alpha}}{\Universe{\gamma}}}

\infer[\rulename{cong-name-paths}]
{\alpha\in\FF\\
  \eqterm{\G}{\e_{\T}}{\e_{\U}}{\Universe{\alpha}}\\
  \eqterm{\G}{\e_1}{\e'_1}{\El{\alpha}{\e_{\T}}}\\
  \eqterm{\G}{\e_2}{\e'_2}{\El{\alpha}{\e_{\T}}}
}
{\eqterm{\G}{\nPrEqual{\alpha}{\e_T}{\e_1}{\e_2}}{\nPrEqual{\alpha}{\e_U}{\e'_1}{\e'_2}}{\Universe{\alpha}}}

\infer[\rulename{cong-name-id}]
{\eqterm{\G}{\e_T}{\e_U}{\Universe{\alpha}}\\
  \eqterm{\G}{\e_1}{\e'_1}{\El{\alpha}{\e_{\T}}}\\
  \eqterm{\G}{\e_2}{\e'_2}{\El{\alpha}{\e_{\T}}}
}
{\eqterm{\G}{\nJuEqual{\alpha}{\e_T}{\e_1}{\e_2}}{\nJuEqual{\alpha}{\e_U}{\e'_1}{\e'_2}}{\Universe{\alpha}}}
\end{mathpar}

\noindent
Congruence rule for coercions:
%
\begin{mathpar}
  \infer[\rulename{cong-name-coerce}]
  {\eqterm{\G}{\e_1}{\e_2}{\Universe{\alpha}}}
  {\eqterm{\G}{(\coerce{\e_1}{\alpha}{\beta})}
              {(\coerce{\e_2}{\alpha}{\beta})}
              {\Universe{\beta}}}
\end{mathpar}

\noindent
Functoriality of corecions:
%
\begin{mathpar}
\infer[\rulename{eq-name-coerce-refl}]
  {\isterm{\G}{\e}{\Universe{\alpha}}}
  {\eqterm{\G}{(\coerce{\e}{\alpha}{\alpha})}{e}{\Universe{\alpha}}}

\infer[\rulename{eq-name-coerce-trans}]
  {\isterm{\G}{\e}{\Universe{\alpha}} \\
    \alpha \leq \beta \leq \gamma}
  {\eqterm{\G}{\coerce{(\coerce{\e}{\alpha}{\beta}}{\beta}{\gamma})}
              {\coerce{\e}{\alpha}{\gamma}}
              {\Universe{\gamma}}}
\end{mathpar}


\section{Bidirectional type theory with hints}
\label{sec:bidir-type-theory}

We now define a bidirectional version of type theory with equality hints. This version
only allows hints about term equality, because we only have witnesses for term equality,
not type equality.

\subsection{Syntax}
\label{sec:syntax-bidirectional}

Contexts:
%
\begin{equation*}
  \G
  \begin{aligned}[t]
    \bnf   {}& \ctxempty & & \text{empty context}\\
    \bnfor {}& \ctxextend{\G}{\x}{\T} & & \text{context extended with $x : T$}
  \end{aligned}
\end{equation*}
%
Equality hints:
%
\begin{equation*}
  \H
  \begin{aligned}[t]
    \bnf   {}& \ctxempty & & \text{empty hints}\\
    \bnfor {}& \addhinteq{\H}{\e_1}{\e_2} & & \text{extend hints with a term equation} \\
    \bnfor {}& \addhintred{\H}{\e_1}{\e_2} & & \text{extend hints with a term reduction} \\
  \end{aligned}
\end{equation*}
%
Types:
%
\begin{equation*}
  \T, \U
  \begin{aligned}[t]
    \bnf   {}& \Universe{\alpha} & & \text{universe}\\
    \bnfor {}& \El{\alpha}{\e} & & \text{type named by $e$}\\
    \bnfor {}& \Unit & & \text{the unit type}\\
    \bnfor {}& \Prod{x}{\T} \U & & \text{product}\\
    \bnfor {}& \PrEqual{T}{\e_1}{\e_2} & & \text{path type}\\
    \bnfor {}& \JuEqual{T}{\e_1}{\e_2} & & \text{equality type}
  \end{aligned}
\end{equation*}
%
Terms:
%
\begin{equation*}
  \e
  \begin{aligned}[t]
    \bnf   {}&  \x   &&\text{variable} \\
    \bnfor {}&  \hintin{\e_1} e_2 &&\text{use hint $\e_1$ in $\e_2$} \\
    \bnfor {}&  \ascribe{\e}{\T}  &&\text{ascribe type $\T$ to term $\e$} \\
    \bnfor {}&  \lam{\x}{\T} \e  &&\text{$\lambda$-abstraction} \\
    \bnfor {}&   \app{\e_1}{\e_2}  &&\text{application} \\
    \bnfor {}&  \unitTerm  &&\text{the element of unit type} \\
    \bnfor {}&  \prRefl{\T}{\e}  &&\text{identity path} \\
    \bnfor {}&  \PrElim{\T}{\abst{x\,y\,p}{\U}}{\abst{z}{\e_1}}{\e_2}{\e_3}{\e_4}  &&\text{path eliminator} \\
    \bnfor {}&  \juRefl{\T}{\e}  &&\text{reflexivity} \\
    \bnfor {}&  \JuElim{\T}{\abst{x\,y\,p}{\U}}{\abst{z}{\e_1}}{\e_2}{\e_3}{\e_4}  &&\text{equality eliminator} \\
    \bnfor {}&  \nUnit  &&\text{the name of unit type} \\
    \bnfor {}&  \nProd{\alpha,\beta}{\x}{\e_1} \e_2  &&\text{the name of product type} \\
    \bnfor {}&  \nUniverse{\alpha} &&\text{the name of a universe} \\
    \bnfor {}&  \coerce{\e}{\alpha}{\beta}  &&\text{universe coercion} \\
    \bnfor {}&  \nPrEqual{\alpha}{\e_1}{\e_2}{\e_3}  &&\text{the name of a path type} \\
    \bnfor {}&  \nJuEqual{\alpha}{\e_1}{\e_2}{\e_3}  &&\text{the name of an equality type}
  \end{aligned}
\end{equation*}

\subsection{Judgments}
\label{sec:bidirectional-judgments}

\begin{align*}
& \isctxalg{\G}{\H} & & \text{$\G$ and $\H$ form a typing context with hints} \\
& \istypealg{\GH}{\T} & & \text{$\T$ is a well-formed type} \\
& \isfibalg{\GH}{\T} & & \text{$\T$ is a well-formed fibered type} \\
& \chkterm{\GH}{\e}{\T} & & \text{check that term $\e$ has type $T$} \\
& \synterm{\GH}{\e}{\T} & & \text{synthesize type $\T$ of term $e$} \\
& \eqtypealg{\GH}{\T}{\U} & & \text{$\T$ and $\U$ are equal types} \\
& \eqtermalg{\GH}{\e_1}{\e_2}{\T} & & \text{$\e_1$ and $\e_2$ are equal terms of type $\T$} \\
& \whnf{\GH}{\e_1}{\e_2} & & \text{$\e_1$ weak-head-normalizes to $\e_2$ }
\end{align*}

\subsection{Contexts with hints}
\label{sec:contexts-with-hints}

\begin{mathpar}
  \infer[\rulename{htctx-empty}]
  { }
  {\isctxalg{\ctxempty}{\hintempty}}

  \infer[\rulename{htctx-extend-ctx}]
  {\isctxalg{\G}{\H} \\
   \istypealg{\GH}{\T}
  }
  {\isctxalg{(\ctxextend{\G}{\x}{\T})}{\H}}

  \infer[\rulename{htctx-extend-eq-hint}]
  {\isctxalg{\G}{\H} \\
   \eqtermalg{\GH}{\e_1}{\e_2}{\T}
  }
  {\isctxalg{\G}{(\addhinteq{\H}{\e_1}{\e_2})}}

  \infer[\rulename{htctx-extend-red-hint}]
  {\isctxalg{\G}{\H} \\
   \eqtermalg{\GH}{\e_1}{\e_2}{\T}
  }
  {\isctxalg{\G}{(\addhintred{\H}{\e_1}{\e_2})}}

\end{mathpar}

Actually, this whole section should be written in a declarative fashion.

\subsection{Types}
\label{sec:bidirectional-types}

\begin{mathpar}
  \infer[\rulename{tychk-universe}]
  {\alpha \in \PP
  }
  {\istypealg{\GH}{\Universe{\alpha}}}

  \infer[\rulename{tychk-prod}]
  {\istypealg{\GH}{\T} \\
   \istypealg{\ctxs{(\ctxextend{\G}{\x}{\T})}{\H}}{\U}
  }
  {\istypealg{\GH}{\Prod{\x}{\T}{\U}}}

  \infer[\rulename{tychk-el}]
  {\chkterm{\GH}{\e}{\Universe{\alpha}}}
  {\istypealg{\GH}{\El{\alpha}{\e}}}

  \infer[\rulename{tychk-unit}]
  {\isctxalg{\G}{\H}}
  {\istypealg{\GH}{\Unit}}

  \infer[\rulename{tychk-paths}]
  {\isfibalg{\GH}{\T}\\
   \chkterm{\GH}{\e_1}{\T}\\
   \chkterm{\GH}{\e_2}{\T}
  }
  {\istypealg{\GH}{\PrEqual{\T}{\e_1}{\e_2}}}

  \infer[\rulename{tychk-id}]
  {\istypealg{\GH}{\T}\\
   \chkterm{\GH}{\e_1}{\T}\\
   \chkterm{\GH}{\e_2}{\T}
  }
  {\istypealg{\GH}{\JuEqual{\T}{\e_1}{\e_2}}}
\end{mathpar}


\subsection{Well-Formed Fibered types}
\label{sec:bidirectional-fibered-types}

\begin{mathpar}
  \infer[\rulename{fibchk-universe}]
  {\alpha \in \PP
  }
  {\isfibalg{\GH}{\Universe{\alpha}}}

  \infer[\rulename{fibchk-prod}]
  {\isfibalg{\GH}{\T} \\
   \isfibalg{\ctxs{(\ctxextend{\G}{\x}{\T})}{\H}}{\U}
  }
  {\isfibalg{\GH}{\Prod{\x}{\T}{\U}}}

  \infer[\rulename{fibchk-el}]
  {\chkterm{\GH}{\e}{\Universe{\alpha}}\\
   \alpha\in\FF
  }
  {\isfibalg{\GH}{\El{\alpha}{\e}}}

  \infer[\rulename{fibchk-unit}]
  {}
  {\isfibalg{\GH}{\Unit}}

  \infer[\rulename{fibchk-paths}]
  {\isfibalg{\GH}{\T}\\
   \chkterm{\GH}{\e_1}{\T}\\
   \chkterm{\GH}{\e_2}{\T}
  }
  {\isfibalg{\GH}{\PrEqual{\T}{\e_1}{\e_2}}}
\end{mathpar}

If we already know the given type is well-formed, there's an even simpler algorithm to see if it is fibered.


\subsection{Terms}
\label{sec:bidirectional-terms}

General rules:
%
\begin{mathpar}
  \infer[\rulename{syn-var}]
  {
    (\x {:} \T) \in \G
  }
  { \synterm{\GH}{\x}{\T}}

  \infer[\rulename{syn-ascribe}]
  { \chkterm{\GH}{\e}{\T}}
  { \synterm{\GH}{\ascribe{\e}{\T}}{\T} }

  \infer[\rulename{chk-syn}]
  { \synterm{\GH}{\e}{\U} \\
    \eqtype{\GH}{\U}{\T}
  }
  { \chkterm{\GH}{\e}{\T} }
\end{mathpar}
%
Hints:
%
\begin{mathpar}
  \infer[\rulename{syn-eq-hint}]
  { \synterm{\GH}{\e_1}{\U'} \\
    \whnf{\GH}{\U'}{\JuEqual{\U}{\e_3}{\e_4}} \\
    \synterm{\ctxs{\G}{(\addhinteq{\H}{\e_3}{\e_4})}}{\e_2}{\T}
  }
  { \synterm{\GH}{(\hintin{\e_1} \e_2)}{\T} }

  \infer[\rulename{chk-eq-hint}]
  { \synterm{\GH}{\e_1}{\U'} \\
    \whnf{\GH}{\U'}{\JuEqual{\U}{\e_3}{\e_4}} \\
    \chkterm{\ctxs{\G}{(\addhinteq{\H}{\e_3}{\e_4})}}{\e_2}{\T}
  }
  { \chkterm{\GH}{(\hintin{\e_1} \e_2)}{\T} }
\end{mathpar}
%
Products:
%
\begin{mathpar}
  \infer[\rulename{syn-abs}]
  { \synterm{\ctxextend{\G}{\x}{\T} ; \H}{\e}{\U} }
  { \synterm{\GH}{(\lam{\x}{\T}{\e})}{\Prod{\x}{\T} \U} }

  \infer[\rulename{syn-app}]
  { \synterm{\GH}{\e_1}{\Prod{\x}{\T} \U}
    \\
    \chkterm{\GH}{\e_2}{\T}
  }
  { \chkterm{\GH}{\app{\e_1}{\e_2}}{\subst{\U}{\x}{\e_2}} }
\end{mathpar}
%
Unit type:
%
\begin{mathpar}
  \infer[\rulename{syn-unit}]
  { }
  { \synterm{\GH}{\unitTerm}{\Unit} }
\end{mathpar}
%
Path type:
%
\begin{mathpar}
  \infer[\rulename{syn-idpath}]
  { \chkterm{\GH}{\e}{\T} }
  { \synterm{\GH}{\prRefl{\T}{\e}}{\PrEqual{\T}{\e}{\e}} }

  \infer[\rulename{syn-j}]
  { \isfibalg{\GH}{\T}
     \\\\
    \isfibalg{
      \ctxextend{\ctxextend{\ctxextend{\G}{x}{\T}}{y}{\T}}{p}{\PrEqual{\T}{x}{y}} ;
      \H
    }{\U}
    \\\\
    \chkterm
      {\ctxextend{\G}{z}{\T} ; \H}
      {\e_1}
      {\substs{\U}{z/x, z/y, (\prRefl{\T}{z})/p}}
    \\\\
    \chkterm{\GH}{\e_2}{\T} \\\\
    \chkterm{\GH}{\e_3}{\T} \\\\
    \chkterm{\GH}{\e_4}{\PrEqual{\T}{\e_2}{\e_3}}
  }
  { \synterm{\GH}{
      \PrElim{\T}
             {\abst{x\,y\,p}{\U}}
             {\abst{z}{\e_1}}
             {\e_2}
             {\e_3}
             {\e_4}
    }{\substs{\U}{\e_2/x, \e_3/y, \e_4/p}} }
\end{mathpar}
%
Equality type:
%
\begin{mathpar}
  \infer[\rulename{syn-refl}]
  { \chkterm{\GH}{\e}{\T} }
  { \synterm{\GH}{\juRefl{\T}{\e}}{\JuEqual{\T}{\e}{\e}} }

  \infer[\rulename{syn-g}]
  { \istypealg{\GH}{\T}
     \\\\
    \istypealg{
      \ctxextend{\ctxextend{\ctxextend{\G}{x}{\T}}{y}{\T}}{p}{\JuEqual{\T}{x}{y}} ;
      \H
    }{\U}
    \\\\
    \chkterm
      {\ctxextend{\G}{z}{\T} ; \H}
      {\e_1}
      {\substs{\U}{z/x, z/y, (\juRefl{\T}{z})/p}}
    \\\\
    \chkterm{\GH}{\e_2}{\T} \\\\
    \chkterm{\GH}{\e_3}{\T} \\\\
    \chkterm{\GH}{\e_4}{\JuEqual{\T}{\e_2}{\e_3}}
  }
  { \synterm{\GH}{
      \JuElim{\T}
             {\abst{x\,y\,p}{\U}}
             {\abst{z}{\e_1}}
             {\e_2}
             {\e_3}
             {\e_4}
    }{\substs{\U}{\e_2/x, \e_3/y, \e_4/p}} }
\end{mathpar}
%
Names:
%
\begin{mathpar}
  \infer[\rulename{syn-name-unit}]
  { }
  { \synterm{\GH}{\nUnit}{\Universe{\zero}} }

  \infer[\rulename{syn-name-universe}]
  {
    \uClose{\alpha} = \beta
  }
  { \synterm{\GH}{\nUniverse{\alpha}}{\Universe{\beta}} }

  \infer[\rulename{syn-name-prod}]
  { \chkterm{\GH}{\e_1}{\Universe{\alpha}}
    \\
    \chkterm
    {\ctxs{(\ctxextend{\G}{\x}{\El{\alpha}{\e_1}})}{\H}}
    {\e_2}
    {\Universe{\beta}}
    \\
    \piClose{\alpha}{\beta} = \gamma
  }
  { \synterm{\GH}{(\nProd{\alpha,\beta}{\x}{\e_1}{\e_2})}{\Universe{\gamma}} }

  \infer[\rulename{syn-name-coerce}]
  { \chkterm{\GH}{\e}{\Universe{\alpha}}
    \\
    \alpha \leq \beta
  }
  { \synterm{\GH}{\coerce{\alpha}{\beta}{\e}}{\Universe{\beta}} }

  \infer[\rulename{syn-name-paths}]
  {\chkterm{\G}{\e_\T}{\Universe{\alpha}}\\
   \alpha\in\FF\\
   \chkterm{\G}{\e_1}{\El{\alpha}{\e_\T}}\\
   \chkterm{\G}{\e_2}{\El{\alpha}{\e_\T}}
  }
  {\synterm{\G}{\nPrEqual{\alpha}{\e_T}{\e_1}{\e_2}}{\Universe{\alpha}}}


  \infer[\rulename{syn-name-id}]
  {\chkterm{\G}{\e_\T}{\Universe{\alpha}}\\
   \chkterm{\G}{\e_1}{\El{\alpha}{\e_\T}}\\
   \chkterm{\G}{\e_2}{\El{\alpha}{\e_\T}}
  }
  {\synterm{\G}{\nJuEqual{\alpha}{\e_\T}{\e_1}{\e_2}}{\Universe{\alpha}}}
\end{mathpar}

\subsection{Type equality}
\label{sec:bidirectional-type-equality}

Reflexivity is (ought to be) admissible, but we include it for efficiency:
%
\begin{mathpar}
  \infer[\rulename{chk-tyeq-refl}]
  { \istype{\GH}{\T} }
  { \eqtype{\GH}{\T}{\T} }
\end{mathpar}
%
Other types:
\begin{mathpar}
  \infer[\rulename{chk-tyeq-universe}]
  {\isctxalg{\G}{\H} \\ \alpha = \beta}
  {\eqtype{\GH}{\Universe{\alpha}}{\Universe{\beta}}}

  \infer[\rulename{chk-tyeq-el}]
  { \eqterm{\GH}{\e_1}{\e_2}{\Universe{\alpha}}
    \\
    \alpha = \beta
  }{
    \eqtype{\GH}{\El{\alpha}{\e_1}}{\El{\beta}{\e_2}}
  }

  \infer[\rulename{chk-tyeq-prod}]
  { \eqtype{\GH}{\T_1}{\U_1}
    \\
    \eqtype
    {\ctxextend{\G}{\x}{\T_1} ; \H}
    {\T_2}
    {\U_2}
  }
  { \eqtype{\GH}
    {\Prod{\x}{\T_1}{\T_2}}
    {\Prod{\x}{\U_1}{\U_2}}
  }

  \infer[\rulename{chk-tyeq-paths}]
  {\isfib{\GH}{\T}\\
   \isfib{\GH}{\U}\\\\
   \eqtype{\GH}{\T}{\U}\\
   \eqterm{\GH}{\e_1}{\e'_1}{\T}\\
   \eqterm{\GH}{\e_2}{\e'_2}{\T}
  }
  {\eqtype{\GH}{\PrEqual{\T}{\e_1}{\e_2}}
               {\PrEqual{\U}{\e'_1}{\e'_2}}}

  \infer[\rulename{chk-tyeq-id}]
  {\eqtype{\GH}{\T}{\U}\\
   \eqterm{\GH}{\e_1}{\e'_1}{\T}\\
   \eqterm{\GH}{\e_2}{\e'_2}{\T}
  }
  {\eqtype{\GH}{\JuEqual{\T}{\e_1}{\e_2}}
               {\JuEqual{\U}{\e'_1}{\e'_2}}}
\end{mathpar}
%

\subsection{Term normalization}
\label{sec:term-normalization}

Normalization by hints:
%
\begin{mathpar}
  \infer[\rulename{norm-hint-abs}]
  { \isctxalg{\G}{\H} \\
    \eqtermhint{\e}{(\lam{\x}{\U}{\e'})}{\T} \in \H
  }
  { \whnf{\GH}{\e}{(\lam{\x}{\U}{\e'})} }

  \infer[\rulename{norm-hint-idpath}]
  { \isctxalg{\G}{\H} \\
    \eqtermhint{\e}{\prRefl{\U}{\e'}} \in \H
  }
  { \whnf{\GH}{\e}{\prRefl{\U}{\e'}} }

  \infer[\rulename{norm-hint-refl}]
  { \isctxalg{\G}{\H} \\
    \eqtermhint{\e}{\juRefl{\U}{\e'}} \in \H
  }
  { \whnf{\GH}{\e}{\juRefl{\U}{\e'}} }
\end{mathpar}
%
Cancelation of eliminators and constructors:
%
\begin{mathpar}
  \infer[\rulename{norm-app-beta}]
  { \whnf{\GH}{\subst{\e_1}{\x}{\e_2}}{\e_3}{\T} }
  { \whnf
    {\GH}
    {\app{(\lam{\x}{\U}{\e_1})}{\e_2}}
    {\e_3}
    {\T}
  }

  \infer[\rulename{norm-idpath}]
  {
    \isctxalg{\G}{\H}
  }
  {
    \whnf
    {\GH}
    {\PrElim
      {\T}
      {\abst{x\,y\,p}{\U}}
      {\abst{z}{\e_1}}
      {\e_2}
      {\e_2}
      {\prRefl{\T}{\e_2}}
    }
    {\subst{\e_1}{z}{\e_2}}
    {\substs{\U}{\e_2/x, \e_2/y, (\prRefl{\T}{\e_2})/p}}
  }

\end{mathpar}

\subsection{Term equality}
\label{sec:bidirectional-term-equality}

For algorithmic purposes we should try to apply reflexivity and hints before doing
anything else:
%
\begin{mathpar}
  \infer[\rulename{chk-eq-refl}]
  { \chkterm{\GH}{\e}{\T} }
  { \eqtermalg{\GH}{\e}{\e}{\T} }

  \infer[\rulename{chk-eq-hint}]
  { \isctxalg{\G}{\H}
    \\
    \eqtermhint{\e_1}{\e_2} \in \H
  }
  { \eqtermalg{\GH}{\e_1}{\e_2}{\T} }

  \infer[\rulename{chk-eq-hint-sym}]
  { \isctxalg{\G}{\H}
    \\
    \eqtermhint{\e_2}{\e_1} \in \H
  }
  { \eqtermalg{\GH}{\e_1}{\e_2}{\T} }
\end{mathpar}

\end{document}
