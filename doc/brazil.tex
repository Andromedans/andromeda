\documentclass{article}

\usepackage{times}
\usepackage{mathpartir}
\usepackage{amsmath,amsfonts,amssymb}

%% Macros here

% Universe indices

\newcommand{\NN}{\mathbb{N}} % God-given numbers

\newcommand{\PP}{\mathbb{P}} % the poset of universe indices
\newcommand{\FF}{\mathbb{F}} % the subposet of fibered universe indices
\newcommand{\zero}{o} % this is not o, it is omicron

\newcommand{\piClose}[2]{\mathsf{max}(#1,#2)}   % the universe containing a pi with given domain and codomain
\newcommand{\uClose}[1]{\mathsf{succ}(#1)}  % the universe containing the given universe's name.

% Generic entities
\newcommand{\G}{\Gamma} % a context
\newcommand{\T}{T} % a type
\newcommand{\U}{U} % another type
\newcommand{\x}{x} % a term variable
\newcommand{\y}{y} % another term variable
\newcommand{\e}{e} % a term

\newcommand{\rulename}[1]{\text{\textsc{#1}}}

%% Syntax
\newcommand{\bnf}{\ \mathrel{{:}{:}{=}}\ }
\newcommand{\bnfor}{\ \mid\ \ }

%% Syntactic constructs
\newcommand{\ctxempty}{\bullet} % empty context
\newcommand{\ctxextend}[3]{#1,\, #2\, {:}\, #3} % extended context

\newcommand{\subst}[3]{#1[#3/#2]} % substitution
\newcommand{\substs}[2]{#1[#2]} % substitution of many variables

\newcommand{\Universe}[1]{\mathbb{U}_{#1}} % non-fibered universe
\newcommand{\El}[1]{\mathsf{El}\, #1} % the type named by the term

\newcommand{\Unit}{\mathsf{Unit}} % The unit type
\newcommand{\Prod}[2]{\mathop{\textstyle\prod_{(#1 {:} #2)}}} % dependent product

\newcommand{\lam}[2]{\lambda #1 {:} #2 \,.\,} % $\lambda$-abstraction
\newcommand{\app}[2]{#1\,#2} % application

\newcommand{\abst}[2]{[#1 \,.\, #2]} % abstraction
\newcommand{\ascribe}[2]{#1 \,{:}{:}\, #2} % type ascription

\newcommand{\unitTerm}{(\,)} % the element of the unit type

\newcommand{\coerce}[2]{\mathsf{coerce}_{#1} \, #2}

\newcommand{\PrEqual}[3]{\mathsf{Paths}_{#1}(#2,#3)} % Propositional Equality type
\newcommand{\JuEqual}[3]{\mathsf{Id}_{#1}(#2,#3)} % Judgmental Equality type

\newcommand{\PrElim}[4]{\mathsf{J}_{#1}(#2, #3, #4)} % Propositional equality eliminator
\newcommand{\PrElimS}[3]{\mathsf{J}(#1, #2, #3)} % Synthesizing propositional equality eliminator

\newcommand{\prRefl}[1]{\mathop{\mathsf{idpath}_{#1}}}  % Propositional refl
\newcommand{\juRefl}[1]{\mathop{\mathsf{refl}_{#1}}}    % Judgmental refl

% names
\newcommand{\nUnit}{\mathsf{unit}} % name of unit type
\newcommand{\nProd}[2]{\pi #1\,{:}\,#2 \,.\ } % name of a dependent product
\newcommand{\nUniverse}[1]{u_{#1}}  % name of a universe
\newcommand{\nPrEqual}[3]{\mathsf{paths}_{#1}(#2,#3)} % Propositional Equality type
\newcommand{\nJuEqual}[3]{\mathsf{id}_{#1}(#2,#3)} % Judgmental Equality type


% orthodox judgments
\newcommand{\isctx}[1]{#1\;\mathsf{ctx}} % well formed context
\newcommand{\istype}[2]{#1 \vdash #2\;\mathsf{type}} % well formed type
\newcommand{\isfib}[2]{#1 \vdash #2\;\mathsf{fibered}} % is a fibered type
\newcommand{\isterm}[3]{#1 \vdash\,#2\,:\,#3} % well formed term

\newcommand{\eqtype}[3]{#1 \vdash #2 \equiv #3} % equal types
\newcommand{\eqterm}[4]{#1 \vdash #2 \equiv #3 : #4} % equal terms

% algorithmic judgments

\newcommand{\chkterm}[3]{#1 \vdash #2 \Leftarrow #3} % checking
\newcommand{\synterm}[3]{#1 \vdash #2 \Rightarrow #3} % synthesis

\newcommand{\ishints}[2]{#1 \vdash #2 \; \mathsf{hints}} % well-formed context and hints

\newcommand{\istypealg}[2]{#1 \vdash #2 \Leftarrow \mathsf{type}} % well formed type
\newcommand{\isfibalg}[2]{#1 \vdash #2 \Leftarrow \mathsf{fibered}} % is a fibered type
\newcommand{\eqtypealg}[3]{#1 \vdash #2 \thickapprox #3} % equal types
\newcommand{\eqtypepath}[3]{#1 \vdash #2 \thicksim #3} % equal normal-form types
\newcommand{\eqtermalg}[4]{#1 \vdash #2 \thickapprox #3 \Leftarrow #4} % equal terms of normalized type
\newcommand{\eqtermext}[4]{#1 \vdash #2 \simeq #3 \Leftarrow #4} % equal normal-form terms
\newcommand{\eqpath}[4]{#1 \vdash #2 \thicksim #3 \Rightarrow #4} % equal terms

\newcommand{\equationin}[1]{\mathsf{equation}\; #1 \; \mathsf{in} \;} % use equation hint
\newcommand{\rewritein}[1]{\mathsf{rewrite}\; #1 \; \mathsf{in} \;} % use rewrite hint
\newcommand{\eqtermhint}[2]{(#1 \,{\equiv}\, #2)} % equality hint
\newcommand{\redtermhint}[2]{(#1 \,{\leadsto}\, #2)} % rewrite hint

\renewcommand{\H}{\mathcal{H}}      % term hint list
\newcommand{\hintempty}{\circ}      % empty hint list

\newcommand{\addhinteq}[3]{#1, \eqtermhint{#2}{#3}} % extended hint list
\newcommand{\addhintred}[3]{#1, \redtermhint{#2}{#3}} % extended hint list
\newcommand{\ctxs}[2]{#1\,;\,#2}
\newcommand{\GH}{\ctxs{\G}{\H}}           % combined context and hints

% normalization

\newcommand{\tywhnf}[3]{#1 \vdash #2 \leadsto #3 } % "one-step type normalization"
\newcommand{\whnf}[3]{#1 \vdash #2 \leadsto #3 } % "one-step term normalization"

\newcommand{\tywhnfs}[3]{#1 \vdash #2 \leadsto^* #3 \not\leadsto } % "type normalization"
\newcommand{\whnfs}[3]{#1 \vdash #2 \leadsto^* #3 \not\leadsto } % "term normalization"
\begin{document}

\title{Brazilian type theory}
\author{Andrej Bauer \and Christopher A. Stone}
\maketitle

\section{Universe indices}
\label{sec:universe-indices}

There is a pointed poset $(\PP, {\leq}, \zero)$ of \emph{universe
  indices} and a subset $\FF \subseteq \PP$ of \emph{fibered indices}.
For example, we may take
%
\begin{equation*}
  \PP = \{0,1\} \times \NN
\end{equation*}
%
with the lexicographic order, $\zero = (0,0)$ and $\FF = \{0\} \times
\NN$. We use lowercase Greek letters for universe indices.

We assume partial functions
\begin{itemize}
  \item $\piClose{\cdot}{\cdot} : \PP \times \PP \rightharpoonup \PP$
  \item $\uClose{\cdot}  : \PP \rightharpoonup \PP$
\end{itemize}
%
satisfying
%
\begin{itemize}
\item for all $\alpha, \beta \in \FF$, if $\piClose{\alpha}{\beta}$ is defined then
  $\piClose{\alpha}{\beta} \in \FF$,
\item for all $\alpha \in \PP$, if $\uClose{\alpha}$ is defined then $\uClose{\alpha} \in
  \FF$.
\end{itemize}
%
The functions are \emph{not} required to compute maximum or successor, but we use the
suggestive notation because in the standard case they do compute maxima and succesors.

\section{The orthodox formulation}
\label{sec:orthodox-formulation}

In this section we give the formulation of Brazilian type theory in the orthodox way, with
typing and equality judgments.

\subsection{Syntax}
\label{sec:syntax}

Contexts:
%
\begin{equation*}
  \G
  \begin{aligned}[t]
    \bnf   {}& \ctxempty & & \text{empty context}\\
    \bnfor {}& \ctxextend{\G}{\x}{\T} & & \text{context extended with $x : T$}
  \end{aligned}
\end{equation*}
%
Types:
%
\begin{equation*}
  \T, \U
  \begin{aligned}[t]
    \bnf   {}& \Universe{\alpha} & & \text{universe}\\
    \bnfor {}& \El{\e} & & \text{type named by $e$}\\
    \bnfor {}& \Unit & & \text{the unit type}\\
    \bnfor {}& \Prod{x}{\T} \U & & \text{product}\\
    \bnfor {}& \PrEqual{T}{\e_1}{\e_2} & & \text{path type}\\
    \bnfor {}& \JuEqual{T}{\e_1}{\e_2} & & \text{equality type}
  \end{aligned}
\end{equation*}
%
Terms:
%
\begin{equation*}
  \e
  \begin{aligned}[t]
    \bnf   {}&  \x   &&\text{variable} \\
    \bnfor {}&  \lam{\x}{\T} \e  &&\text{$\lambda$-abstraction} \\
    \bnfor {}&  \app{\e_1}{\e_2}  &&\text{application} \\
    \bnfor {}&  \unitTerm  &&\text{the element of unit type} \\
    \bnfor {}&  \prRefl{\T}{\e}  &&\text{identity path} \\
    \bnfor {}&  \PrElim{\T}{\abst{x\,y\,p}{\U}}{\abst{z}{\e_1}}{\e_2}  &&\text{path eliminator} \\
    \bnfor {}&  \juRefl{\T} \e  &&\text{reflexivity} \\
    \bnfor {}&  \coerce{\alpha}{\e}  &&\text{universe coercion} \\
    \bnfor {}&  \nUnit  &&\text{the name of unit type} \\
    \bnfor {}&  \nProd{\x}{\e_1} \e_2  &&\text{the name of product type} \\
    \bnfor {}&  \nUniverse{\alpha} &&\text{the name of a universe} \\
    \bnfor {}&  \nPrEqual{\e_1}{\e_2}{\e_3}  &&\text{the name of a path type} \\
    \bnfor {}&  \nJuEqual{\e_1}{\e_2}{\e_3}  &&\text{the name of an equality type}
  \end{aligned}
\end{equation*}

\subsection{Judgments}
\label{sec:judgments}

\begin{align*}
& \isctx{\G} & & \text{$\G$ is a well formed context} \\
& \istype{\G}{\T} & & \text{$\T$ is a type in context $\G$} \\
& \isfib{\G}{\T} & & \text{$\T$ is a fibered type in context $\G$} \\
& \isterm{\G}{\e}{\T} & & \text{$\e$ is a well formed term of type $\T$ in context $\G$} \\
& \eqtype{\G}{\T}{\U} & & \text{$\T$ and $\U$ are equal types in context $\G$} \\
& \eqterm{\G}{\e_1}{\e_2}{\T} & & \text{$e_1$ and $e_2$ are equal terms of type $\T$ in context $\G$}
\end{align*}

\subsection{Contexts}
\label{sec:contexts}

\begin{mathpar}
  \infer[\rulename{ctx-empty}]
  { }
  {\isctx{\ctxempty}}

  \infer[\rulename{ctx-extend}]
  {\isctx{\G} \\
   \istype{\G}{\T}
  }
  {\isctx{\ctxextend{\G}{\x}{\T}}}
\end{mathpar}

\subsection{Types}
\label{sec:types}

\begin{mathpar}
  \infer[\rulename{ty-universe}]
  {\isctx{\G} \\
   \alpha \in \PP
  }
  {\istype{\G}{\Universe{\alpha}}}

  \infer[\rulename{ty-prod}]
  {\istype{\G}{\T} \\
   \istype{\ctxextend{\G}{\x}{\T}}{\U}
  }
  {\istype{\G}{\Prod{\x}{\T}{\U}}}

  \infer[\rulename{ty-el}]
  {\isterm{\G}{\e}{\Universe{\alpha}}}
  {\istype{\G}{\El{\e}}}

  \infer[\rulename{ty-unit}]
  {\isctx{\G}}
  {\istype{\G}{\Unit}}

  \infer[\rulename{ty-paths}]
  {\isfib{\G}{\T}\\
   \isterm{\G}{\e_1}{\T}\\
   \isterm{\G}{\e_2}{\T}
  }
  {\istype{\G}{\PrEqual{\T}{\e_1}{\e_2}}}

  \infer[\rulename{ty-id}]
  {\istype{\G}{\T}\\
   \isterm{\G}{\e_1}{\T}\\
   \isterm{\G}{\e_2}{\T}
  }
  {\istype{\G}{\JuEqual{\T}{\e_1}{\e_2}}}
\end{mathpar}

\subsection{Fibered types}
\label{sec:fibered-types}

\begin{mathpar}
  \infer[\rulename{fib-universe}]
  {\isctx{\G} \\
   \alpha \in \PP
  }
  {\isfib{\G}{\Universe{\alpha}}}

  \infer[\rulename{fib-prod}]
  {\isfib{\G}{\T} \\
   \isfib{\ctxextend{\G}{\x}{\T}}{\U}
  }
  {\isfib{\G}{\Prod{\x}{\T}{\U}}}

  \infer[\rulename{fib-el}]
  {\isterm{\G}{\e}{\Universe{\alpha}} \\
   \alpha \in \FF
  }
  {\isfib{\G}{\El{\e}}}

  \infer[\rulename{fib-unit}]
  {\isctx{\G} \\
   \zero\in\FF }
  {\istype{\G}{\Unit}}

  \infer[\rulename{fib-paths}]
  {\isfib{\G}{\T}\\
   \isterm{\G}{\e_1}{\T}\\
   \isterm{\G}{\e_2}{\T}
  }
  {\isfib{\G}{\PrEqual{\T}{\e_1}{\e_2}}}

\end{mathpar}

\subsection{Terms}
\label{sec:terms}

\paragraph{General terms}

\begin{mathpar}
  \infer[\rulename{term-eq}]
  {\isterm{\G}{\e}{\T} \\
   \eqtype{\G}{\T}{\U}
  }
  {\isterm{\G}{\e}{\U}}

  \infer[\rulename{term-var}]
  {\isctx{\G} \\
   (\x{:}\T) \in \G
  }
  {\isterm{\G}{\x}{\T}}
\end{mathpar}

\paragraph{Products}

\begin{mathpar}
  \infer[\rulename{term-abs}]
  {\isterm{\ctxextend{\G}{\x}{\T}}{\e}{\U}}
  {\isterm{\G}{(\lam{\x}{\T}{\e})}{\Prod{\x}{\T}{\U}}}

  \infer[\rulename{term-app}]
  {\isterm{\G}{\e_1}{\Prod{x}{\T} \U} \\
   \isterm{\G}{\e_2}{\T}
  }
  {\isterm{\G}{\app{\e_1}{\e_2}}{\subst{\U}{\x}{\e_2}}}
\end{mathpar}

\paragraph{Paths}

\begin{mathpar}
  \infer[\rulename{term-idpath}]
  {\isterm{\G}{\e}{\T}\\
   \isfib{\G}{\T}}
  {\isterm{\G}{\prRefl{\T}{\e}}{\PrEqual{\T}{\e}{\e}}}

  \infer[\rulename{term-j}]
  {\isfib{\G}{\T}
   \\\\
   \isfib{
     \ctxextend{\ctxextend{\ctxextend{\G}{x}{\T}}{y}{\T}}{p}{\PrEqual{\T}{x}{y}}
   }{\U}
   \\
   \isterm
     {\ctxextend{\G}{z}{\T}}
     {\e_1}
     {\substs{\U}{z/x, z/y, (\prRefl{\T}{z})/p}}
   \\
   \isterm{\G}{\e_3}{\T} \\
   \isterm{\G}{\e_4}{\T} \\
   \isterm{\G}{\e_2}{\PrEqual{\T}{\e_3}{\e_4}}
  }
  {\isterm
     {\G}
     {\PrElim{\T}
        {\abst{x\,y\,p}{\U}}
        {\abst{z}{\e_1}}
        {\e_2}
     }
     {\substs{\U}{\e_2/x, \e_3/y, \e_4/p}}
  }
\end{mathpar}

\paragraph{Equality types}

\begin{mathpar}
  \infer[\rulename{term-refl}]
  {\isterm{\G}{\e}{\T}}
  {\isterm{\G}{\juRefl{\T} \e}{\JuEqual{\T}{\e}{\e}}}
\end{mathpar}

\paragraph{Unit}
\begin{mathpar}
\infer[\rulename{term-star}]
  {\isctx{\G}}
  {\isterm{\G}{\unitTerm}{\Unit}}
\end{mathpar}

\paragraph{Names}

\begin{mathpar}
  \infer[\rulename{term-coerce}]
  {\isterm{\G}{\e}{\Universe{\alpha}}\\
   \alpha \leq \beta}
  {\isterm{\G}{\coerce{\beta}{\e}}{\Universe{\beta}}}

  \infer[\rulename{name-unit}]
  {\isctx{\G}}
  {\isterm{\G}{\nUnit}{\Universe{\zero}}}

  \infer[\rulename{name-universe}]
  {\isctx{\G} \\ \uClose{\alpha} = \beta }
  {\isterm{\G}{\nUniverse{\alpha}}{\Universe{\beta}}}

  \infer[\rulename{name-prod}]
  {\isterm{\G}{\e_1}{\Universe{\alpha}} \\
   \isterm{\ctxextend{\G}{\x}{\El{\e_1}}}{\e_2}{\Universe{\beta}} \\
   \piClose{\alpha}{\beta} = \gamma
  }
  {\isterm{\G}{(\nProd{\x}{\e_1} \e_2)}{\Universe{\gamma}}}

  \infer[\rulename{name-paths}]
  {\isterm{\G}{\e_\T}{\Universe{\alpha}}\\
   \alpha\in\FF\\
   \isterm{\G}{\e_1}{\El{\e_\T}}\\
   \isterm{\G}{\e_2}{\El{\e_\T}}
  }
  {\isterm{\G}{\nPrEqual{\e_T}{\e_1}{\e_2}}{\Universe{\alpha}}}

  \infer[\rulename{name-id}]
  {\isterm{\G}{\e_\T}{\Universe{\alpha}}\\
   \isterm{\G}{\e_1}{\El{\e_\T}}\\
   \isterm{\G}{\e_2}{\El{\e_\T}}
  }
  {\isterm{\G}{\nJuEqual{\e_\T}{\e_1}{\e_2}}{\Universe{\alpha}}}

\end{mathpar}

\subsection{Type Equality}

\paragraph{General rules}

\begin{mathpar}
  \infer[\rulename{tyeq-refl}]
  {\istype{\G}{\T}}
  {\eqtype{\G}{\T}{\T}}

  \infer[\rulename{tyeq-sym}]
  {\eqtype{\G}{\U}{\T}}
  {\eqtype{\G}{\T}{\U}}

  \infer[\rulename{tyeq-trans}]
  {\eqtype{\G}{\T}{\T'}\\
   \eqtype{\G}{\T'}{\U}}
  {\eqtype{\G}{\T}{\U}}
\end{mathpar}


\paragraph{Type formers are congruences}

\begin{mathpar}
  \infer[\rulename{tycong-el}]
  {\eqterm{\G}{\e_1}{\e_2}{\Universe{\alpha}}}
  {\eqtype{\G}{\El{\e_1}}{\El{\e_2}}}

  \infer[\rulename{tycong-prod}]
  {\eqtype{\G}{\T_1}{\U_1}\\
   \eqtype{\ctxextend{\G}{\x}{\T_1}}{\T_2}{\U_2}}
  {\eqtype{\G}{\Prod{\x}{\T_1}{\T_2}}{\Prod{\x}{\U_1}{\U_2}}}

  \infer[\rulename{tycong-paths}]
  {\isfib{\G}{\T}\\
   \isfib{\G}{\U}\\\\
   \eqtype{\G}{\T}{\U}\\
   \eqterm{\G}{\e_1}{\e'_1}{\T}\\
   \eqterm{\G}{\e_2}{\e'_2}{\T}
  }
  {\eqtype{\G}{\PrEqual{\T}{\e_1}{\e_2}}
              {\PrEqual{\U}{\e'_1}{\e'_2}}}

  \infer[\rulename{tycong-id}]
  {\eqtype{\G}{\T}{\U}\\
   \eqterm{\G}{\e_1}{\e'_1}{\T}\\
   \eqterm{\G}{\e_2}{\e'_2}{\T}
  }
  {\eqtype{\G}{\JuEqual{\T}{\e_1}{\e_2}}
              {\JuEqual{\U}{\e'_1}{\e'_2}}}
\end{mathpar}


\paragraph{Computation of types from names}

\begin{mathpar}
  \infer[\rulename{tyeq-el-pi}]
  {\isterm{\G}{\e_1}{\Universe{\alpha}} \\
   \isterm{\ctxextend{\G}{x}{\El{\e_1}}}{\e_2}{\Universe{\beta}} \\
   \piClose{\alpha}{\beta} = \gamma}
  {\eqtype{\G}{\El{(\nProd{\x}{\e_1}{\e_2})}}
              {\Prod{\x}{\El{\e_1}}{\El{\e_2}}}}

  \infer[\rulename{tyeq-el-unit}]
  { }
  {\eqtype{\G}{\El{\nUnit}}{\Unit}}

  \infer[\rulename{tyeq-el-coerce}]
  {\isterm{\G}{\e}{\Universe{\alpha}} \\
    \alpha \leq \beta
  }
  {\eqtype{\G}{\El{(\coerce{\beta}{\e})}}
              {\El{\e}}}

  \infer[\rulename{tyeq-el-paths}]
  {\isterm{\G}{\e_\T}{\Universe{\alpha}}\\
   \alpha\in\FF\\
   \isterm{\G}{\e_1}{\El{\e_\T}}\\
   \isterm{\G}{\e_2}{\El{\e_\T}}
  }
  {\eqtype{\G}{\El{(\nPrEqual{\e_T}{\e_1}{\e_2})}}
          {\PrEqual{\El{\e_\T}}{\e_1}{\e_2}}}

  \infer[\rulename{tyeq-el-id}]
  {\isterm{\G}{\e_\T}{\Universe{\alpha}}\\
   \isterm{\G}{\e_1}{\El{\e_\T}}\\
   \isterm{\G}{\e_2}{\El{\e_\T}}
  }
  {\eqtype{\G}{\El{(\nJuEqual{\e_\T}{\e_1}{\e_2})}}
          {\JuEqual{\El{\e_\T}}{\e_1}{\e_2}}}

\end{mathpar}

\subsection{Term Equality}

General rules:
\begin{mathpar}
  \infer[\rulename{eq-refl}]
  {\isterm{\G}{\e}{\T}}
  {\eqterm{\G}{\e}{\e}{\T}}

  \infer[\rulename{eq-sym}]
  {\eqterm{\G}{\e_2}{\e_1}{\T}}
  {\eqterm{\G}{\e_1}{\e_2}{\T}}

  \infer[\rulename{eq-trans}]
  {\eqterm{\G}{\e_1}{\e_2}{\T}\\
   \eqterm{\G}{\e_2}{\e_3}{\T}}
  {\eqterm{\G}{\e_1}{\e_3}{\T}}

  \infer[\rulename{eq-eq}]
  {\eqterm{\G}{\e_1}{\e_2}{\T}\\
    \eqtype{\G}{\T}{\U}}
  {\eqterm{\G}{\e_1}{\e_2}{\U}}
\end{mathpar}


\paragraph{Congruence rules for products}

%
\begin{mathpar}
  \infer[\rulename{cong-abs}]
  {\eqtype{\G}{\T_1}{\U_1}\\
    \eqterm{\ctxextend{\G}{\x}{\T_1}}{\e_1}{\e_2}{\T_2}}
  {\eqterm{\G}{(\lam{\x}{\T_1}{\e_1})}
              {(\lam{\x}{\U_1}{\e_2})}
              {\Prod{\x}{\T_1}{\T_2}}}

  \infer[\rulename{cong-app}]
  {\eqterm{\G}{\e_1}{\e'_1}{\Prod{\x}{\T}{\U}}\\
   \eqterm{\G}{\e_2}{\e'_2}{\T}}
  {\eqterm{\G}{\app{\e_1}{\e_2}}{\app{\e'_1}{\e'_2}}{\subst{\U}{\x}{\e_2}}}
\end{mathpar}


\paragraph{Other rules for products}

%
\begin{mathpar}
\infer[\rulename{eq-beta}]
  {\isterm{\ctxextend{\G}{\x}{\T}}{\e_1}{\U}\\
    \isterm{\G}{\e_2}{\T}}
  {\eqterm{\G}{\app{(\lam{\x}{\T}{\e_1})}{\e_2}}
              {\subst{\e_1}{\x}{\e_2}}
              {\subst{\U}{\x}{\e_2}}}

  \infer[\rulename{eq-ext}]
  {\isterm{\G}{\e_1}{\Prod{\x}{\T}{\U}}\\
   \isterm{\G}{\e_2}{\Prod{\x}{\T}{\U}}\\
   \eqterm{\ctxextend{\G}{\x}{\T}}{\app{\e_1}{\x}}
          {\app{\e_2}{\x}}{\U}
  }
  {\eqterm{\G}{\e_1}{\e_2}{\Prod{\x}{\T}{\U}}}
\end{mathpar}


\paragraph{Congruence rules for paths}

%
\begin{mathpar}
\infer[\rulename{cong-idpath}]
  {\eqterm{\G}{\e_1}{\e_2}{\T}\\
   \eqtype{\G}{\T}{\U}\\
   \isfib{\G}{\T}\\
   \isfib{\G}{\U}}
  {\eqterm{\G}{\prRefl{\T}{\e_1}}{\prRefl{\U}{\e_2}}{\PrEqual{\T}{\e_1}{\e_1}}}

  \infer[\rulename{cong-j}]
  {\isfib{\G}{\T} \\
   \isfib{\G}{\U}
   \\\\
   \isfib{
     \ctxextend{\ctxextend{\ctxextend{\G}{x}{\T}}{y}{\T}}{p}{\PrEqual{\T}{x}{y}}
   }{P}
   \\
   \isfib{
     \ctxextend{\ctxextend{\ctxextend{\G}{x}{\U}}{y}{\U}}{p}{\PrEqual{\U}{x}{y}}
   }{Q}
   \\\\
   \eqtype{\G}{\T}{\U} \\
   \eqtype{
     \ctxextend{\ctxextend{\ctxextend{\G}{x}{\T}}{y}{\T}}{p}{\PrEqual{\T}{x}{y}}
   }{P}{Q} \\\\
   \eqterm{\ctxextend{\G}{z}{\T}}{\e_1}{\e'_1}{\substs{P}{z/x, z/y, (\prRefl{\T}{z})/p}}
   \\\\
   \eqterm{\G}{\e_3}{\e'_3}{T} \\
   \eqterm{\G}{\e_4}{\e'_4}{T} \\
   \eqterm{\G}{\e_2}{\e'_2}{\PrEqual{\T}{\e_3}{\e_4}}
  }
  {\eqterm
     {\G}
     {\PrElim{\T}
        {\abst{x\,y\,p}{P}}
        {\abst{z}{\e_1}}
        {\e_2}
     }
     {\PrElim{\U}
        {\abst{x\,y\,p}{Q}}
        {\abst{z}{\e'_1}}
        {\e'_2}
     }
     {\substs{P}{\e_2/x, \e_3/y, \e_4/p}}
  }

\end{mathpar}


\paragraph{Computation rule for paths}

%
\begin{mathpar}
  \infer[\rulename{eq-J}]
  {\isfib{\G}{\T}
   \\
   \isfib{
     \ctxextend{\ctxextend{\ctxextend{\G}{x}{\T}}{y}{\T}}{p}{\PrEqual{\T}{x}{y}}
   }{\U}
   \\\\
   \isterm
     {\ctxextend{\G}{z}{\T}}
     {\e_1}
     {\substs{\U}{z/x, z/y, (\prRefl{\T}{z})/p}}
   \\
   \isterm{\G}{\e_2}{\T}
  }
  {\eqterm{\G}
   {\PrElim{\T}
        {\abst{x\,y\,p}{\U}}
        {\abst{z}{\e_1}}
        {\e_2}
        {\e_2}
        {\prRefl{\T}{\e_2}}
   }
   {\subst{\e_1}{z}{\e_2}}
   {\substs{\U}{\e_2/x, \e_2/x, (\prRefl{T}{\e_2})/p}}
  }
\end{mathpar}


\paragraph{Congruence rules for equalities}

%
\begin{mathpar}
\infer[\rulename{cong-refl}]
{\eqterm{\G}{\e_1}{\e_2}{\T}\\
 \eqtype{\G}{\T}{\U}}
{\eqterm{\G}{\juRefl{\T} \e_1}{\juRefl{\U} \e_2}{\JuEqual{\T}{\e_1}{\e_1}}}
\end{mathpar}


\paragraph{Equality reflection}

%
\begin{mathpar}
  \infer[\rulename{eq-reflection}]
  {\isterm{\G}{\e}{\JuEqual{\T}{\e_1}{\e_2}}}
  {\eqterm{\G}{\e_1}{\e_2}{\T}}
\end{mathpar}

\paragraph{Congruence rules for names}

%
\begin{mathpar}
\infer[\rulename{cong-name-prod}]
  {\eqterm{\G}{\e_1}{\e'_1}{\Universe{\alpha}}\\
   \eqterm{\ctxextend{\G}{\x}{\El{\e_1}}}{\e_2}{\e'_2}{\Universe{\beta}} \\
   \piClose{\alpha}{\beta} = \gamma}
  {\eqterm{\G}{(\nProd{\x}{\e_1}{\e_2})}{(\nProd{\x}{\e'_1}{\e'_2})}{\Universe{\gamma}}}

\infer[\rulename{cong-name-universe}]
{\isctx{\G} \\
  \uClose{\alpha} = \gamma
}
{\eqterm{\G}{\nUniverse{\alpha}}{\nUniverse{\alpha}}{\Universe{\gamma}}}

\infer[\rulename{cong-name-paths}]
{\alpha\in\FF\\
  \eqterm{\G}{\e_{\T}}{\e_{\U}}{\Universe{\alpha}}\\
  \eqterm{\G}{\e_1}{\e'_1}{\El{\e_{\T}}}\\
  \eqterm{\G}{\e_2}{\e'_2}{\El{\e_{\T}}}
}
{\eqterm{\G}{\nPrEqual{\e_T}{\e_1}{\e_2}}{\nPrEqual{\e_U}{\e'_1}{\e'_2}}{\Universe{\alpha}}}

\infer[\rulename{cong-name-id}]
{\eqterm{\G}{\e_T}{\e_U}{\Universe{\alpha}}\\
  \eqterm{\G}{\e_1}{\e'_1}{\El{\e_{\T}}}\\
  \eqterm{\G}{\e_2}{\e'_2}{\El{\e_{\T}}}
}
{\eqterm{\G}{\nJuEqual{\e_T}{\e_1}{\e_2}}{\nJuEqual{\e_U}{\e'_1}{\e'_2}}{\Universe{\alpha}}}
\end{mathpar}


\paragraph{Congruence rule for coercions}

%
\begin{mathpar}
  \infer[\rulename{cong-name-coerce}]
  {\eqterm{\G}{\e_1}{\e_2}{\Universe{\alpha}} \\
    \alpha \leq \beta
  }
  {\eqterm{\G}{(\coerce{\beta}{\e_1})}
              {(\coerce{\beta}{\e_2})}
              {\Universe{\beta}}}
\end{mathpar}


\paragraph{Functoriality of coercions}

%
\begin{mathpar}
\infer[\rulename{eq-name-coerce-trivial}]
  {\isterm{\G}{\e}{\Universe{\alpha}}}
  {\eqterm{\G}{(\coerce{\alpha}{\e})}{\e}{\Universe{\alpha}}}

\infer[\rulename{eq-name-coerce-trans}]
  {\isterm{\G}{\e}{\Universe{\alpha}} \\
    \alpha \leq \beta \leq \gamma}
  {\eqterm{\G}{\coerce{\gamma}{(\coerce{\beta}{\e})})}
              {\coerce{\gamma}{\e}}
              {\Universe{\gamma}}}
\end{mathpar}


\section{Bidirectional type theory with hints}
\label{sec:bidir-type-theory}

We now define a bidirectional version of type theory with equality hints. This version
only allows hints about term equality, because we only have witnesses for term equality,
not type equality.

\subsection{Syntax}
\label{sec:syntax-bidirectional}

Contexts:
%
\begin{equation*}
  \G
  \begin{aligned}[t]
    \bnf   {}& \ctxempty & & \text{empty context}\\
    \bnfor {}& \ctxextend{\G}{\x}{\T} & & \text{context extended with $x : T$}
  \end{aligned}
\end{equation*}
%
Equality hints:
%
\begin{equation*}
  \H
  \begin{aligned}[t]
    \bnf   {}& \ctxempty & & \text{empty hints}\\
    \bnfor {}& \addhinteq{\H}{\e_1}{\e_2} & & \text{extend hints with a term equation} \\
    \bnfor {}& \addhintred{\H}{\e_1}{\e_2} & & \text{extend hints with a term reduction} \\
  \end{aligned}
\end{equation*}
%
Types:
%
\begin{equation*}
  \T, \U
  \begin{aligned}[t]
    \bnf   {}& \Universe{\alpha} & & \text{universe}\\
    \bnfor {}& \El{\e} & & \text{type named by $e$}\\
    \bnfor {}& \Unit & & \text{the unit type}\\
    \bnfor {}& \Prod{x}{\T} \U & & \text{product}\\
    \bnfor {}& \PrEqual{T}{\e_1}{\e_2} & & \text{path type}\\
    \bnfor {}& \JuEqual{T}{\e_1}{\e_2} & & \text{equality type}
  \end{aligned}
\end{equation*}
%
Terms:
%
\begin{equation*}
  \e
  \begin{aligned}[t]
    \bnf   {}&  \x   &&\text{variable} \\
    \bnfor {}&  \equationin{\e_1} e_2 &&\text{use equality hint $\e_1$ in $\e_2$} \\
    \bnfor {}&  \rewritein{\e_1} e_2 &&\text{use normalization hint $\e_1$ in $\e_2$} \\
    \bnfor {}&  \ascribe{\e}{\T}  &&\text{ascribe type $\T$ to term $\e$} \\
    \bnfor {}&  \lam{\x}{\T} \e  &&\text{$\lambda$-abstraction} \\
    \bnfor {}&  \unitTerm  &&\text{the element of unit type} \\
    \bnfor {}&  \prRefl{\T}{\e}  &&\text{identity path} \\
    \bnfor {}&  \PrElimS{\e_1}{\abst{x\,y\,p}{\U}}{\abst{z}{\e_2}}  &&\text{path eliminator} \\
    \bnfor {}&  \juRefl{\T} \e  &&\text{reflexivity} \\
    \bnfor {}&  \coerce{\e}{\alpha}  &&\text{universe coercion} \\
    \bnfor {}&  \nUnit  &&\text{the name of unit type} \\
    \bnfor {}&  \nProd{\x}{\e_1} \e_2  &&\text{the name of product type} \\
    \bnfor {}&  \nUniverse{\alpha} &&\text{the name of a universe} \\
    \bnfor {}&  \nPrEqual{\e_1}{\e_2}{\e_3}  &&\text{the name of a path type} \\
    \bnfor {}&  \nJuEqual{\e_1}{\e_2}{\e_3}  &&\text{the name of an equality type}
  \end{aligned}
\end{equation*}

\subsection{Judgments}
\label{sec:bidirectional-judgments}

\begin{align*}
& \ishints{\G}{\H} & & \text{$\H$ consists of legal hints} \\
& \istypealg{\GH}{\T} & & \text{$\T$ is a well-formed type} \\
& \isfibalg{\GH}{\T} & & \text{$\T$ is a well-formed fibered type} \\
& \chkterm{\GH}{\e}{\T} & & \text{check that term $\e$ has type $T$} \\
& \synterm{\GH}{\e}{\T} & & \text{synthesize type $\T$ of term $e$} \\
& \eqtypealg{\GH}{\T}{\U} & & \text{$\T$ and $\U$ are equal types} \\
& \eqtypepath{\GH}{\T}{\U} & & \text{$\T$ and $\U$ are equal head-normal types} \\
& \eqtermalg{\GH}{\e_1}{\e_2}{\T} & & \text{$\e_1$ and $\e_2$ are equal terms of type $\T$} \\
& \eqtermext{\GH}{\e_1}{\e_2}{\T} & & \text{$\e_1$ and $\e_2$ are equal terms of normalized type $\T$} \\
& \eqpath{\GH}{\e_1}{\e_2}{\T} & & \text{$\e_1$ and $\e_2$ are equal normal forms of type $\T$} \\
& \whnf{\GH}{\e_1}{\e_2} & & \text{$\e_1$ weak-head-normalizes to $\e_2$ }
\end{align*}

\subsection{Contexts with hints}
\label{sec:contexts-with-hints}

\begin{mathpar}
  \infer[\rulename{hint-empty}]
  {\isctx{\G}}
  {\ishints{\G}{\hintempty}}

  \infer[\rulename{hint-eq}]
  {\ishints{\G}{\H} \\
   \eqterm{\G}{\e_1}{\e_2}{\T}
  }
  {\ishints{\G}{(\addhinteq{\H}{\e_1}{\e_2})}}

  \infer[\rulename{hint-reduce}]
  {\ishints{\G}{\H} \\
   \eqterm{\G}{\e_1}{\e_2}{\T}
  }
  {\ishints{\G}{(\addhintred{\H}{\e_1}{\e_2})}}

\end{mathpar}
%
Note that this judgment is \emph{not} invoked by the algorithm. It is used only in
describing the conditions under which the algorithm is expected to work.

\subsection{Well-formed types}
\label{sec:bidirectional-types}

\begin{mathpar}
  \infer[\rulename{tychk-universe}]
  {\alpha \in \PP
  }
  {\istypealg{\GH}{\Universe{\alpha}}}

  \infer[\rulename{tychk-prod}]
  {\istypealg{\GH}{\T} \\
   \istypealg{\ctxs{(\ctxextend{\G}{\x}{\T})}{\H}}{\U}
  }
  {\istypealg{\GH}{\Prod{\x}{\T}{\U}}}

  \infer[\rulename{tychk-el}]
  {\synterm{\GH}{\e}{\Universe{\alpha}}}
  {\istypealg{\GH}{\El{\e}}}

  \infer[\rulename{tychk-unit}]
  {}
  {\istypealg{\GH}{\Unit}}

  \infer[\rulename{tychk-paths}]
  {\isfibalg{\GH}{\T}\\
   \chkterm{\GH}{\e_1}{\T}\\
   \chkterm{\GH}{\e_2}{\T}
  }
  {\istypealg{\GH}{\PrEqual{\T}{\e_1}{\e_2}}}

  \infer[\rulename{tychk-id}]
  {\istypealg{\GH}{\T}\\
   \chkterm{\GH}{\e_1}{\T}\\
   \chkterm{\GH}{\e_2}{\T}
  }
  {\istypealg{\GH}{\JuEqual{\T}{\e_1}{\e_2}}}
\end{mathpar}


\subsection{Well-formed fibered types}
\label{sec:bidirectional-fibered-types}

\begin{mathpar}
  \infer[\rulename{fibchk-universe}]
  {\alpha \in \PP
  }
  {\isfibalg{\GH}{\Universe{\alpha}}}

  \infer[\rulename{fibchk-prod}]
  {\isfibalg{\GH}{\T} \\
   \isfibalg{\ctxs{(\ctxextend{\G}{\x}{\T})}{\H}}{\U}
  }
  {\isfibalg{\GH}{\Prod{\x}{\T}{\U}}}

  \infer[\rulename{fibchk-el}]
  {\synterm{\GH}{\e}{\Universe{\alpha}}\\
   \alpha\in\FF
  }
  {\isfibalg{\GH}{\El{\e}}}

  \infer[\rulename{fibchk-unit}]
  {}
  {\isfibalg{\GH}{\Unit}}

  \infer[\rulename{fibchk-paths}]
  {\isfibalg{\GH}{\T}\\
   \chkterm{\GH}{\e_1}{\T}\\
   \chkterm{\GH}{\e_2}{\T}
  }
  {\isfibalg{\GH}{\PrEqual{\T}{\e_1}{\e_2}}}
\end{mathpar}
%
If we already know the given type is well-formed, there's an even simpler algorithm to see if it is fibered:
%
\newcommand{\simplefib}{\mathop{\mathsf{isfib}}\,}
\newcommand{\true}{\mathsf{true}}
\newcommand{\false}{\mathsf{false}}
\begin{align*}
\simplefib{\Universe{\alpha}}        & \;\mathrel{{:}{=}}\;  \true \\
\simplefib{\Prod{\x}{\T}{\U}}        & \;\mathrel{{:}{=}}\;  \simplefib{T}\ \land\ \simplefib{U} \\
\simplefib{\El{\e}}                  & \;\mathrel{{:}{=}}\;  \alpha\in\FF \\
\simplefib{\Unit}                    & \;\mathrel{{:}{=}}\;  \true \\
\simplefib{\PrEqual{\T}{\e_1}{\e_2}} & \;\mathrel{{:}{=}}\;  \true \\
\simplefib{\JuEqual{\T}{\e_1}{\e_2}} & \;\mathrel{{:}{=}}\;  \false
\end{align*}

\subsection{Terms}
\label{sec:bidirectional-terms}

\paragraph{General rules}

\begin{mathpar}
  \infer[\rulename{syn-var}]
  {
    (\x {:} \T) \in \G
  }
  { \synterm{\GH}{\x}{\T}}

  \infer[\rulename{syn-ascribe}]
  {\istypealg{\GH}{\T} \\
   \chkterm{\GH}{\e}{\T}}
  { \synterm{\GH}{\ascribe{\e}{\T}}{\T} }

  \infer[\rulename{chk-syn}]
  { \synterm{\GH}{\e}{\U} \\
    \eqtypealg{\GH}{\U}{\T}
  }
  { \chkterm{\GH}{\e}{\T} }
\end{mathpar}

\paragraph{Hints}

\begin{mathpar}
  \infer[\rulename{syn-eq-hint}]
  { \synterm{\GH}{\e_1}{\U'} \\
    \whnf{\GH}{\U'}{\JuEqual{\U}{\e_3}{\e_4}} \\
    \synterm{\ctxs{\G}{(\addhinteq{\H}{\e_3}{\e_4})}}{\e_2}{\T}
  }
  { \synterm{\GH}{(\equationin{\e_1} \e_2)}{\T} }

  \infer[\rulename{chk-eq-hint}]
  { \synterm{\GH}{\e_1}{\U'} \\
    \whnf{\GH}{\U'}{\JuEqual{\U}{\e_3}{\e_4}} \\
    \chkterm{\ctxs{\G}{(\addhinteq{\H}{\e_3}{\e_4})}}{\e_2}{\T}
  }
  { \chkterm{\GH}{(\equationin{\e_1} \e_2)}{\T} }

  \infer[\rulename{syn-eq-hint}]
  { \synterm{\GH}{\e_1}{\U'} \\
    \whnf{\GH}{\U'}{\JuEqual{\U}{\e_3}{\e_4}} \\
    \synterm{\ctxs{\G}{(\addhintred{\H}{\e_3}{\e_4})}}{\e_2}{\T}
  }
  { \synterm{\GH}{(\rewritein{\e_1} \e_2)}{\T} }

  \infer[\rulename{chk-eq-hint}]
  { \synterm{\GH}{\e_1}{\U'} \\
    \whnf{\GH}{\U'}{\JuEqual{\U}{\e_3}{\e_4}} \\
    \chkterm{\ctxs{\G}{(\addhintred{\H}{\e_3}{\e_4})}}{\e_2}{\T}
  }
  { \chkterm{\GH}{(\rewritein{\e_1} \e_2)}{\T} }
\end{mathpar}

\paragraph{Products}

\begin{mathpar}
  \infer[\rulename{syn-abs}]
  { \synterm{\ctxextend{\G}{\x}{\T} ; \H}{\e}{\U} }
  { \synterm{\GH}{(\lam{\x}{\T} \e)}{\Prod{\x}{\T} \U} }

  \infer[\rulename{syn-app}]
  { \synterm{\GH}{\e_1}{\Prod{\x}{\T} \U} \\
    \chkterm{\GH}{\e_2}{\T}
  }
  { \synterm{\GH}{\app{\e_1}{\e_2}}{\subst{\U}{\x}{\e_2}} }
\end{mathpar}

\paragraph{Unit type}

\begin{mathpar}
  \infer[\rulename{syn-unit}]
  { }
  { \synterm{\GH}{\unitTerm}{\Unit} }
\end{mathpar}

\paragraph{Path type}

\begin{mathpar}
  \infer[\rulename{syn-idpath}]
  { \chkterm{\GH}{\e}{\T} }
  { \synterm{\GH}{\prRefl{\T}{\e}}{\PrEqual{\T}{\e}{\e}} }

  \infer[\rulename{syn-j}]
  {
    \synterm{\GH}{\e_1}{\PrEqual{\T}{\e_3}{\e_4}}
    \\
    \isfibalg{\GH}{\T}
     \\
    \isfibalg{
      \ctxextend{\ctxextend{\ctxextend{\G}{x}{\T}}{y}{\T}}{p}{\PrEqual{\T}{x}{y}} ;
      \H
    }{\U}
    \\
    \chkterm
      {\ctxextend{\G}{z}{\T} ; \H}
      {\e_2}
      {\substs{\U}{z/x, z/y, (\prRefl{\T}{z})/p}}
  }
  { \synterm{\GH}{
     \PrElimS{\e_1}
             {\abst{x\,y\,p}{\U}}
             {\abst{z}{\e_2}}
    }{
      \substs{\U}{\e_3/x, \e_4/y, \e_1/p}
    }
  }
\end{mathpar}

\paragraph{Equality type}

\begin{mathpar}
  \infer[\rulename{syn-refl}]
  { \chkterm{\GH}{\e}{\T} }
  { \synterm{\GH}{\juRefl{\T}{\e}}{\JuEqual{\T}{\e}{\e}} }

\end{mathpar}

\paragraph{Names}

\begin{mathpar}
  \infer[\rulename{syn-name-unit}]
  { }
  { \synterm{\GH}{\nUnit}{\Universe{\zero}} }

  \infer[\rulename{syn-name-universe}]
  {
    \uClose{\alpha} = \beta
  }
  { \synterm{\GH}{\nUniverse{\alpha}}{\Universe{\beta}} }

  \infer[\rulename{syn-name-prod}]
  { \synterm{\GH}{\e_1}{\Universe{\alpha}}
    \\
    \synterm
    {\ctxs{(\ctxextend{\G}{\x}{\El{\e_1}})}{\H}}
    {\e_2}
    {\Universe{\beta}}
    \\
    \piClose{\alpha}{\beta} = \gamma
  }
  { \synterm{\GH}{(\nProd{\x}{\e_1}{\e_2})}{\Universe{\gamma}} }

  \infer[\rulename{syn-name-coerce}]
  { \synterm{\GH}{\e}{\Universe{\alpha}}
    \\
    \alpha \leq \beta
  }
  { \synterm{\GH}{\coerce{\beta}{\e}}{\Universe{\beta}} }

  \infer[\rulename{syn-name-paths}]
  {\synterm{\G}{\e_\T}{\Universe{\alpha}}\\
   \alpha\in\FF\\
   \chkterm{\G}{\e_1}{\El{\e_\T}}\\
   \chkterm{\G}{\e_2}{\El{\e_\T}}
  }
  {\synterm{\G}{\nPrEqual{\e_T}{\e_1}{\e_2}}{\Universe{\alpha}}}


  \infer[\rulename{syn-name-id}]
  {\synterm{\G}{\e_\T}{\Universe{\alpha}}\\
   \chkterm{\G}{\e_1}{\El{\e_\T}}\\
   \chkterm{\G}{\e_2}{\El{\e_\T}}
  }
  {\synterm{\G}{\nJuEqual{\e_\T}{\e_1}{\e_2}}{\Universe{\alpha}}}
\end{mathpar}

\subsection{Type normalization}
\label{sec:type-normalization}

\paragraph{Name reduction (possibly using hints)}
\begin{mathpar}
  \infer[\rulename{tynorm-el}]
  {
    \whnf{\H}{\e}{\e'}
  }
  {
    \whnf{\H}{\El{\e}}{\El{\e'}}
  }
\end{mathpar}

\paragraph{Conversion from name to type}

\begin{mathpar}

  \infer[\rulename{tynorm-pi}]
  {
  }
  {
    \tywhnf{\H}{\El{(\nProd{\x}{\e_1}{e_2})}}
                {\Prod{\x}{\El{\e_1}}{\El{\e}}}
  }

  \infer[\rulename{tynorm-unit}]
  {
  }
  {
    \tywhnf{\H}{\El{\nUnit}}{\Unit}
  }

  \infer[\rulename{tynorm-coerce}]
  {
  }
  {
    \tywhnf{\H}{\El{(\coerce{\beta}{\e}})}{\El{\e}}
  }

  \infer[\rulename{tynorm-paths}]
  {
  }
  {\tywhnf{\H}{\El{(\nPrEqual{\e_T}{\e_1}{\e_2})}}
          {\PrEqual{\El{\e_\T}}{\e_1}{\e_2}}
  }

  \infer[\rulename{tynorm-id}]
  {
  }
  {\tywhnf{\H}{\El{(\nJuEqual{\e_T}{\e_1}{\e_2})}}
          {\JuEqual{\El{\e_\T}}{\e_1}{\e_2}}
  }
\end{mathpar}
%
If $\redtermhint{\nUnit}{\mathsf{nat}} \in \H$, then the priority of the rules
shown will make us try $\whnf{\H}{\El{\nUnit}}{\El{\mathsf{nat}}}$ first.
Only if we backtrack will we consider $\whnf{\H}{\El{\nUnit}}{\Unit}$.

\subsection{Type equality}
\label{sec:bidirectional-type-equality}

\paragraph{General Type equality}

\begin{mathpar}
  \infer[\rulename{chk-tyeq-refl}]
  { }
  { \eqtypealg{\GH}{\T}{\T} }

  \infer[\rulename{chk-tyeq-hnf}]
  { \whnfs{\H}{\T}{\T'}\\
    \whnfs{\H}{\U}{\U'}\\
    \eqtypepath{\GH}{\T'}{\U'}
  }
  {
    \eqtypealg{\GH}{\T}{\U}
  }
\end{mathpar}
%
Reflexivity is an optimization for the common case.

\paragraph{Equality of head-normal forms}
\begin{mathpar}
  \infer[\rulename{chk-tyeq-path-refl}]
  { }
  { \eqtypepath{\GH}{\T}{\T} }

  \infer[\rulename{chk-tyeq-el}]
  { \alpha = \beta \\
    \eqtermalg{\GH}{\e_1}{\e_2}{\Universe{\alpha}}
  }
  {
    \eqtypepath{\GH}{\El{\e_1}}{\El{\e_2}}
  }

  \infer[\rulename{chk-tyeq-prod}]
  { \eqtypealg{\GH}{\T_1}{\U_1} \\
    \eqtypealg {\ctxs{(\ctxextend{\G}{\x}{\T_1})}{\H}}{\T_2}{\U_2}
  }
  { \eqtypepath{\GH}
    {\Prod{\x}{\T_1}{\T_2}}
    {\Prod{\x}{\U_1}{\U_2}}
  }

  \infer[\rulename{chk-tyeq-paths}]
  {\eqtypealg{\GH}{\T}{\U}\\
   \eqtermalg{\GH}{\e_1}{\e'_1}{\T}\\
   \eqtermalg{\GH}{\e_2}{\e'_2}{\T}
  }
  {\eqtypepath{\GH}{\PrEqual{\T}{\e_1}{\e_2}}
                  {\PrEqual{\U}{\e'_1}{\e'_2}}}

  \infer[\rulename{chk-tyeq-id}]
  {\eqtypealg{\GH}{\T}{\U}\\
   \eqtermalg{\GH}{\e_1}{\e'_1}{\T}\\
   \eqtermalg{\GH}{\e_2}{\e'_2}{\T}
  }
  {\eqtypepath{\GH}{\JuEqual{\T}{\e_1}{\e_2}}
                   {\JuEqual{\U}{\e'_1}{\e'_2}}}
\end{mathpar}
%
The reflexivity rule is not just an optimization, but also handles
equivalence of base types and equivalence of universes.

\subsection{Term normalization}
\label{sec:term-normalization}

\paragraph{Normalization by hints}
\begin{mathpar}
  \infer[\rulename{norm-hint}]
  {
    \redtermhint{\e}{\e'} \in \H \\
    \whnf{\GH}{\e'}{\e''}
  }
  { \whnf{\GH}{\e}{\e''} }
\end{mathpar}
%
In the case of multiple hints for reducing $\e'$, we try the most-recently-added hint
(last in the sequence $\H$) first.

\paragraph{Redices}
\begin{mathpar}
  \infer[\rulename{norm-equation}]
  { }
  { \whnf
    {\H}
    {(\equationin{\e_1}{\e_2})}
    {\e_2}
  }

  \infer[\rulename{norm-rewrite}]
  { }
  { \whnf
    {\H}
    {(\rewritein{\e_1}{\e_2})}
    {\e_2}
  }

  \infer[\rulename{norm-ascribe}]
  { }
  { \whnf
    {\H}
    {(\ascribe{\e}{\T})}
    {\e}
  }

  \infer[\rulename{norm-app-beta}]
  { \whnf{\GH}{\subst{\e_1}{\x}{\e_2}}{\e_3} }
  { \whnf
    {\H}
    {\app{(\lam{\x}{\T}{\e_1})}{\e_2}}
    {\e_3}
  }

  \infer[\rulename{norm-idpath}]
  {
  }
  {
    \whnf
    {\H}
    {\PrElimS
      {\prRefl{\T}{\e_1}}
      {\abst{x\,y\,p}{\U}}
      {\abst{z}{\e_2}}
    }
    {\subst{\e_2}{z}{\e_1}}
  }

  \infer[\rulename{norm-coerce-trivial}]
  {
  }
  {
    \whnf{\H}{(\coerce{\alpha}{\e})}{\e}
  }

  \infer[\rulename{norm-coerce-trans}]
  {
  }
  {
    \whnf{\H}
    {\coerce{\gamma}{(\coerce{\beta}{\e})}}
    {\coerce{\gamma}{\e}}
  }
\end{mathpar}


\paragraph{Recursion}

\begin{mathpar}
 \infer[\rulename{norm-app}]
 {\whnf{\H}{\e_1}{\e'_1}}
 {\whnf{\H}{\app{\e_1}{\e_2}}{\app{\e'_1}{\e_2}}}

 \infer[\rulename{norm-J}]
  { \whnf{\H}{\e_1}{\e'_1}}
  { \whnf{\G}{\PrElimS{\e_1}
               {\abst{x\,y\,p}{\U}}
               {\abst{z}{\e_2}}
             }
             {\PrElimS{\e'_1}
               {\abst{x\,y\,p}{\U}}
               {\abst{z}{\e_2}}
             }
  }
\end{mathpar}
%
By rule priority, if $\app{\e_1}{\e_2}$ has no hint and we take one step to
$\app{\e'_1}{\e_2}$, we will look again for a hint for that term before
applying the other rules.

\subsection{Term equality}
\label{sec:bidirectional-term-equality}

For algorithmic purposes we should try to apply reflexivity and hints before doing
anything else:
%
\begin{mathpar}
  \infer[\rulename{chk-eq-refl}]
  { }
  { \eqtermalg{\GH}{\e}{\e}{\T} }

  \infer[\rulename{chk-eq-hint}]
  {
    \eqtermhint{\e_1}{\e_2} \in \H
  }
  { \eqtermalg{\GH}{\e_1}{\e_2}{\T} }

  \infer[\rulename{chk-eq-hint-sym}]
  {
    \eqtermhint{\e_2}{\e_1} \in \H
  }
  { \eqtermalg{\GH}{\e_1}{\e_2}{\T} }
\end{mathpar}
%
Otherwise, we check whether extensionality applies:
%
\begin{mathpar}
  \infer[\rulename{chk-eq-ext}]
  {
    \whnfs{\H}{\T}{\T'} \\
    \eqtermext{\GH}{\e_1}{\e_2}{\T'}
  }
  {
    \eqtermalg{\GH}{\e_1}{\e_2}{\T}
  }
\end{mathpar}

\paragraph{Extensionality}

\begin{mathpar}
  \infer[\rulename{chk-eq-ext-prod}]
  {
    \eqtermalg{\ctxs{(\ctxextend{\G}{\x}{\T})}{\H}}{\app{\e_1}{\x}}{\app{\e_2}{\x}}{\U}
  }
  {
    \eqtermext{\GH}{\e_1}{\e_2}{\Prod{\x}{\T}{\U}}
  }

  \infer[\rulename{chk-eq-ext-unit}]
  {
  }
  {
    \eqtermext{\GH}{\e_1}{\e_2}{\Unit}
  }

  \infer[\rulename{chk-eq-ext-K}]
  {
  }
  {
    \eqtermext{\GH}{\e_1}{\e_2}{\JuEqual{\T}{\e_1}{\e_2}}
  }

  \infer[\rulename{chk-eq-ext-whnf}]
  {
    \whnfs{\H}{\e_1}{\e'_1}\\
    \whnfs{\H}{\e_2}{\e'_2}\\\\
    \eqpath{\GH}{\e'_1}{\e'_2}{\U}
  }
  {
    \eqtermext{\GH}{\e_1}{\e_2}{\T}
  }
\end{mathpar}
%
In \rulename{chk-eq-ext-whnf}, we might want to check whether $\e'_1$ and $\e'_2$ are the
same expressions before invoking the general comparison function.

\paragraph{Whnf equivalence}
\begin{mathpar}
  \infer[\rulename{chk-eq-whnf-equation}]
  {
    \eqtermhint{\e_1}{\e_2} \in \H
  }
  {
    \eqpath{\GH}{\e_1}{\e_2}{\T}
  }


  \infer[\rulename{chk-eq-whnf-var}]
  {
    (\x{:}\T)\in \G
  }
  {
    \eqpath{\GH}{\x}{\x}{\T}
  }

  \infer[\rulename{chk-eq-whnf-app}]
  {
    \eqpath{\GH}{\e_1}{\e'_1}{\T}\\
    \whnfs{\H}{\T}{\Prod{\x}{\T_1}{\T_2}}\\\\
    [ \chkterm{\GH}{\e_2}{\T_1} ]\\
    [ \chkterm{\GH}{\e'_2}{\T_1} ] \\\\
    \eqtermalg{\GH}{\e_2}{\e'_2}{\T_1}\\
  }
  {
    \eqpath{\GH}{\app{\e_1}{\e_2}}{\app{\e'_1}{\e'_2}}
                {\subst{\T_2}{\x}{\e_2}}
  }

  \infer[\rulename{chk-eq-whnf-idpath}]
  {
    \eqtermalg{\GH}{\e_1}{\e_2}{\T}
  }
  {
    \eqpath{\GH}{\prRefl{\T}{\e_1}}{\prRefl{\U}{\e_2}}
                {\PrEqual{\T}{\e_1}{\e_1}}
  }

  \infer[\rulename{chk-eq-whnf-j}]
  {
   \eqpath{\GH}{\e_1}{\e'_1}{\PrEqual{\T}{\e_3}{\e_4}}
    \\
   \eqtypealg
     {\ctxs{(\ctxextend{\ctxextend{\ctxextend{\G}{x}{\T}}{y}{\T}}{p}{\PrEqual{\T}{x}{y}})}{\H}}
     {P}
     {Q}
   \\
   \eqtermalg
     {\ctxs{(\ctxextend{\G}{z}{\T})}{\H}}
     {\e_2}
     {\e'_2}
     {\substs{P}{z/x, z/y, (\prRefl{\T}{z})/p}}
  }
  {\eqpath
     {\GH}
     {\PrElimS{\e_1}
        {\abst{x\,y\,p}{P}}
        {\abst{z}{\e_2}}
     }
     {\PrElimS{\e'_1}
        {\abst{x\,y\,p}{Q}}
        {\abst{z}{\e'_2}}
     }
     {\substs{P}{\e_2/x, \e_3/y, \e_4/p}}
  }

  \infer[\rulename{chk-eq-whnf-refl}]
  {
    \eqtermalg{\GH}{\e_1}{\e_2}{\T}
  }
  {
    \eqpath{\GH}{\juRefl{\T}{\e_1}}{\juRefl{\U}{\e_2}}
                {\JuEqual{\T}{\e_1}{\e_1}}
  }
\end{mathpar}

\paragraph{Whnf equivalence of names}
\begin{mathpar}
  \infer[\rulename{chk-eq-whnf-prod}]
  {\eqpath{\GH}{\e_1}{\e'_1}{\Universe{\alpha}}\\
   \eqpath{\ctxs{(\ctxextend{\G}{\x}{\El{\e_1}})}{\H}}{\e_2}{\e'_2}{\Universe{\beta}} \\
   \piClose{\alpha}{\beta} = \gamma
  }
  {\eqpath{\GH}
    {(\nProd{\x}{\e_1}{\e_2})}
    {(\nProd{\x}{\e'_1}{\e'_2})}
    {\Universe{\gamma}}
  }

  \infer[\rulename{chk-eq-whnf-universe}]
  {
    \alpha = \beta \\
    \uClose{\alpha} = \gamma
  }
  {
    \eqpath{\GH}{\nUniverse{\alpha}}{\nUniverse{\beta}}{\Universe{\gamma}}
  }

  \infer[\rulename{chk-eq-whnf-unit}]
  {
  }
  {
    \eqpath{\GH}{\nUnit}{\nUnit}{\Universe{\zero}}
  }

  \infer[\rulename{chk-eq-whnf-paths}]
  {
    \eqpath{\GH}{\e_{\T}}{\e_{\U}}{\Universe{\alpha}}\\
    \eqtermalg{\GH}{\e_1}{\e'_1}{\El{\e_{\T}}}\\
    \eqtermalg{\GH}{\e_2}{\e'_2}{\El{\e_{\T}}}
  }
  {\eqpath{\GH}{\nPrEqual{\e_T}{\e_1}{\e_2}}{\nPrEqual{\e_U}{\e'_1}{\e'_2}}{\Universe{\alpha}}}

  \infer[\rulename{chk-eq-whnf-id}]
  {
    \eqpath{\GH}{\e_T}{\e_U}{\Universe{\alpha}}\\
    \eqtermalg{\GH}{\e_1}{\e'_1}{\El{\e_{\T}}}\\
    \eqtermalg{\GH}{\e_2}{\e'_2}{\El{\e_{\T}}}
  }
  {\eqpath{\GH}{\nJuEqual{\e_T}{\e_1}{\e_2}}{\nJuEqual{\e_U}{\e'_1}{\e'_2}}{\Universe{\alpha}}}

  \infer[\rulename{chk-eq-whnf-coerce}]
  {
    \eqpath{\GH}{\e_1}{\e_2}{\Universe{\alpha}} \\
    \alpha \leq \beta = \gamma
  }
  {
    \eqpath{\GH}{\coerce{\beta}{\e_1}}
                {\coerce{\gamma}{\e_2}}
                {\Universe{\beta}}
  }

\end{mathpar}
%
Right now we do not have rules for whnf equivalence of the unit value, or of
$\lambda$-abstractions. In principle, extensionality should get rid of these.

\end{document}
