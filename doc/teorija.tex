\documentclass{article}

\usepackage{amsmath,amssymb}
\usepackage{mathpartir}

\newcommand{\Type}{\mathsf{Type}}
\newcommand{\ctx}{\Gamma}
\newcommand{\emptyctx}{\cdot}
\newcommand{\isctx}[1]{#1\ \mathsf{ctx}}

\newcommand{\evalto}{\Longrightarrow}

\newcommand{\jdg}[3]{#1 : #3 \; \left[#2\right]}
\newcommand{\isfresh}[1]{\mathsf{fresh}\;#1}
\newcommand{\of}[1][]{:_{#1}}

\newcommand{\prd}[1]{\Pi #1 \,.\,}
\newcommand{\Eq}[3][]{#2 \equiv_{#1} #3}
\newcommand{\refl}[2][]{\mathsf{refl}_{#1}\,#2}
\newcommand{\fun}[1]{\lambda #1 \,.\,}
\newcommand{\abs}[1]{#1 .}
\newcommand{\app}[3][]{#2 \mathrel{@}^{#1} #3}

\newcommand{\anon}{\_}

\newcommand{\join}{\bowtie}
\newcommand{\splitctx}{\rightsquigarrow}
\newcommand{\ent}[1]{\vdash_{#1}}

\newcommand{\bnfis}{\mathbin{{:}{:}{=}}}
\newcommand{\bnfor}{\mathbin{\mid}}

\begin{document}

\section{Type theory}

\subsection{Syntax}

\begin{align*}
  \text{Expression}\ e, A, B \
    \bnfis \ & x                           & & \text{variable}\\
    \bnfor \ & \Type                       & & \text{type of types}\\
    \bnfor \ & \prd{x : A_1} A_2           & & \text{product} \\
    \bnfor \ & \Eq[A]{e_1}{e_2}            & & \text{strict equality} \\
    \bnfor \ & \refl[A]{e}                 & & \text{reflexivity} \\
    \bnfor \ & \fun{x : A \,.\, B} e               & & \text{$\lambda$-abstraction} \\
    \bnfor \ & \app[\abs{x : A} B]{e_1}{e_2}  & & \text{application}
  \intertext{}
  \text{Context}\ \ctx\
     \bnfis \ & \emptyctx                  & & \text{empty context} \\
     \bnfor \ & \ctx, x : A                & & \text{context extension}
\end{align*}

\subsection{Judgements}

\begin{align*}
  & \isctx{\ctx}                & & \text{$\ctx$ is a context}  \\
  & \ctx \ent{X} e \of A         & & \text{in $\ctx$ $e$ has type $A$ using variables $X$}  \\
  & \ctx \ent{X} e_1 = e_2 \of A & & \text{in $\ctx$ $e_1$ and $e_2$ of type $A$ are equal using variables $X$}
\end{align*}

\subsection{Rules}

\begin{mathpar}

  \infer[form-pi]
  {\ctx \ent{X} A : \Type
  \\
  \ctx, x \of[X      ] A \ent{Y} B : \Type
  }
  {\ctx \ent{X \cup Y} (\prd{x : A} B) \of \Type}

  \infer[hypo]
  {(x : A) \in \Gamma \\
    x \in X \subseteq |\Gamma|}
  {\Gamma \ent{X} x : A}

  \infer[intro-pi]
  {\ctx \ent{X} A \of \Type \\
   \ctx, x : A \ent{Y} B : \Type \\
   \ctx, x : A \ent{Z} e : B
  }
  {\ctx \ent{X \cup (Y \setminus \{x\}) \cup Z} (\fun{x : A \,.\, B} e) : \prd{x : A} B}

\end{mathpar}

\subsubsection{Contexts}

\begin{mathpar}
  \infer[ctx-empty]
  { }
  {\isctx{\emptyctx}}

  \infer[ctx-extend]
  {\isctx{\ctx}
   \\
   \ctx \ent{X} A : \Type
   \\
   x \not\in |\ctx|}
  {\isctx{(\ctx, x \of[X] A)}}
\end{mathpar}


\section{Operational semantics of the kernel}

\begin{mathpar}
  \infer[eval-Type]
  { }
  {\Type \evalto \jdg{\Type}{\emptyctx}{\Type}}

  \infer[eval-Var]
  { \isfresh{\alpha}}
  { x \evalto \jdg{x}{\alpha \of[x] \Type, x \of \alpha}{\alpha}}

  \infer[eval-Prod]
  {
  c_1 \evalto \jdg{e_1}{\ctx_1}{A_1} \\
  c_2 \evalto \jdg{e_2}{\ctx_2}{A_2} \\
  \ctx_2 \splitctx (\ctx'_2, x \of[\emptyset] B)
  }
  {
  \prd{x : c_1} c_2
  \evalto
  \jdg
    {\prd{x : e_1} e_2}
    {\begin{aligned}
     & \ctx_1 \join \ctx'_2, \\
    & \anon \of[\epsilon_1] \Eq[\Type]{A_1}{\Type}, \\
    & \anon \of \prd{x : B} (\Eq[\Type]{A_2}{\Type}),\\
    & \epsilon_1 \of \Eq[\Type]{e_1}{B}
     \end{aligned}
    }{
     \Type
    }
  }

  \infer[eval-Eq]
  {
    c_1 \evalto \jdg{e_1}{\ctx_1}{A_1} \\
    c_2 \evalto \jdg{e_2}{\ctx_2}{A_2} \\
    \isfresh{\alpha}
  }{
    \Eq{c_1}{c_2}
    \evalto
    \jdg
    {
      \Eq[\alpha]{e_1}{e_2}
    }{
      \ctx_1 \join \ctx_2,
      \alpha \of[\epsilon_1,\epsilon_2] \Type,
      \epsilon_1 \of \Eq[\Type]{\alpha}{A_1},
      \epsilon_2 \of \Eq[\Type]{\alpha}{A_2}
    }{
      \Type
    }
  }

  \infer[eval-Refl]
  {c \evalto \jdg{e}{\ctx}{A}}
  {\refl{c}
   \evalto
   \jdg
   {\refl[A]{e}}
   {\ctx}
   {(\Eq[A]{e}{e})}
  }

  \infer[eval-Fun]
  {c \evalto \jdg{e}{\ctx}{A} \\
   \ctx \splitctx (\ctx', x \of[\emptyset] B)
  }{
    (\fun{x} c)
    \evalto
    \jdg
    {(\fun{x:B}{e})}
    {\ctx'}
    {(\prd{x : B} A)}
  }

  \infer[eval-App]
  {
   c_1 \evalto \jdg{e_1}{\ctx_1}{A_1} \\
   c_2 \evalto \jdg{e_2}{\ctx_2}{A_2} \\
   \isfresh{\alpha}
  }
  {
   \app{c_1}{c_2}
   \evalto
   \jdg
   {
    (\app[\abs{x : \alpha} {\app[\abs{\anon : \alpha} \Type]{\beta}{x}}]{e_1}{e_2})
   }{
    \begin{aligned}
    & \ctx_1 \join \ctx_2, \\
    & \alpha \of[\epsilon_1,\epsilon_2] \Type, \\
    & \beta \of[\epsilon_1] \alpha \to \Type, \\
    & \epsilon_1 \of \prd{x : \alpha} (\Eq[\Type]{\app[\abs{\anon : \alpha} \Type]{\beta}{x}}{A_1}), \\
    & \epsilon_2 \of \Eq[\Type]{\alpha}{A_2}
    \end{aligned}
   }{
    (\app[\abs{\anon : \alpha} \Type]{\beta}{e_2})
   }
  }


\end{mathpar}
\end{document}
